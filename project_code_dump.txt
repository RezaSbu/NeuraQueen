.\.env.local:
GEMINI_API_KEY=PLACEHOLDER_API_KEY

-------------------------
.\.gitignore:
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

-------------------------
.\App.tsx:
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Send, Bike, Sparkles, MessageSquare, Plus, Scale, Trash2, Menu, X, LogOut, User as UserIcon } from 'lucide-react';
import { initializeChat, sendMessageToGemini } from './services/geminiService';
import { loadProductDatabase } from './services/productService';
import { authService } from './services/authService';
import { chatPersistence } from './services/chatPersistence';
import ChatMessage from './components/ChatMessage';
import ComparisonModal from './components/ComparisonModal';
import AuthScreen from './components/AuthScreen';
import AdminDashboard from './components/AdminDashboard'; // Import Dashboard
import { ChatMessage as ChatMessageType, Session, ProductMatch, User } from './types';

const App: React.FC = () => {
  // Auth State
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false); // Admin State
  const [authChecked, setAuthChecked] = useState(false);

  // App State
  const [sessions, setSessions] = useState<Session[]>([]);
  const [currentSessionId, setCurrentSessionId] = useState<string>('');
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [comparisonList, setComparisonList] = useState<ProductMatch[]>([]);
  const [showComparison, setShowComparison] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);

  const messagesEndRef = useRef<HTMLDivElement>(null);

  // 1. Initialize App & Check Auth
  useEffect(() => {
    loadProductDatabase();
    initializeChat();
    
    // Check for existing session
    const storedUser = authService.checkLocalSession();
    if (storedUser) {
      setCurrentUser(storedUser);
      loadUserData(storedUser.user_id);
    }
    setAuthChecked(true);
  }, []);

  const loadUserData = async (userId: string) => {
    const userSessions = await chatPersistence.loadUserSessions(userId);
    if (userSessions.length > 0) {
        setSessions(userSessions);
        setCurrentSessionId(userSessions[0].id);
    } else {
        createNewSession(userId, true);
    }
  };

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [sessions, currentSessionId, isLoading]);

  // Session Management
  const createNewSession = (userId = currentUser?.user_id, isInitial = false) => {
    if (!userId) return;

    const newSession: Session = {
      id: Date.now().toString(),
      title: 'Ú†Øª Ø¬Ø¯ÛŒØ¯',
      messages: [{
        id: 'welcome',
        role: 'model',
        text: `Ø³Ù„Ø§Ù… ${currentUser?.name || 'Ø¯ÙˆØ³Øª'} Ø¹Ø²ÛŒØ²! ğŸ‘‹\n\nÙ…Ù† **Mobinext** Ù‡Ø³ØªÙ…. Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø¯Ø± Ø®Ø±ÛŒØ¯ Ù„ÙˆØ§Ø²Ù… Ù…ÙˆØªÙˆØ± Ú©Ù…Ú©ØªÙˆÙ† Ú©Ù†Ù…ØŸ`,
        timestamp: Date.now()
      }],
      lastModified: Date.now()
    };
    
    // Save to State
    if (isInitial) {
        setSessions([newSession]);
    } else {
        setSessions(prev => [newSession, ...prev]);
    }
    setCurrentSessionId(newSession.id);
    setSidebarOpen(false);

    // Persist
    chatPersistence.saveSession(userId, newSession);
  };

  const updateCurrentSession = (newMessages: ChatMessageType[]) => {
    setSessions(prev => {
        const updatedSessions = prev.map(s => {
          if (s.id === currentSessionId) {
            let title = s.title;
            // Update title based on first user message
            if (s.title === 'Ú†Øª Ø¬Ø¯ÛŒØ¯' && newMessages.length > 1) {
                const firstUserMsg = newMessages.find(m => m.role === 'user');
                if (firstUserMsg) title = firstUserMsg.text.slice(0, 30) + '...';
            }
            
            const updatedSession = { ...s, messages: newMessages, title, lastModified: Date.now() };
            
            // Persist to DB asynchronously
            if (currentUser?.user_id) {
                chatPersistence.saveSession(currentUser.user_id, updatedSession);
            }
            
            return updatedSession;
          }
          return s;
        });
        return updatedSessions;
    });
  };

  const deleteSession = async (e: React.MouseEvent, id: string) => {
    e.stopPropagation();
    
    // DB Remove
    await chatPersistence.deleteSession(id);

    // State Remove
    const newSessions = sessions.filter(s => s.id !== id);
    setSessions(newSessions);
    
    if (currentSessionId === id && newSessions.length > 0) {
        setCurrentSessionId(newSessions[0].id);
    } else if (newSessions.length === 0 && currentUser) {
        createNewSession(currentUser.user_id);
    }
  };

  const getCurrentMessages = () => {
    return sessions.find(s => s.id === currentSessionId)?.messages || [];
  };

  // Chat Logic
  const handleSend = async () => {
    if (!input.trim() || isLoading) return;

    const userText = input;
    setInput('');
    setIsLoading(true);

    const currentMsgs = getCurrentMessages();
    const userMsg: ChatMessageType = {
      id: Date.now().toString(),
      role: 'user',
      text: userText,
      timestamp: Date.now()
    };
    
    // Optimistic Update
    const updatedWithUser = [...currentMsgs, userMsg];
    updateCurrentSession(updatedWithUser);

    try {
      const response = await sendMessageToGemini(userText, currentMsgs);
      
      const botMsg: ChatMessageType = {
        id: (Date.now() + 1).toString(),
        role: 'model',
        text: response.text,
        products: response.products,
        timestamp: Date.now()
      };
      
      updateCurrentSession([...updatedWithUser, botMsg]);
    } catch (error) {
      const errorMsg: ChatMessageType = {
        id: (Date.now() + 1).toString(),
        role: 'model',
        text: "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.",
        timestamp: Date.now()
      };
      updateCurrentSession([...updatedWithUser, errorMsg]);
    } finally {
      setIsLoading(false);
    }
  };

  const toggleComparison = useCallback((product: ProductMatch) => {
    setComparisonList(prev => {
        const exists = prev.find(p => p.title === product.title);
        if (exists) {
            return prev.filter(p => p.title !== product.title);
        } else {
            if (prev.length >= 3) {
                alert("Ø­Ø¯Ø§Ú©Ø«Ø± Û³ Ù…Ø­ØµÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
                return prev;
            }
            return [...prev, product];
        }
    });
  }, []);

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const handleLogout = () => {
      authService.logout();
      setCurrentUser(null);
      setSessions([]);
  };

  const onAuthSuccess = (user: User) => {
      setCurrentUser(user);
      loadUserData(user.user_id);
  };
  
  const handleAdminLogout = () => {
      setIsAdminLoggedIn(false);
  };

  // RENDER LOGIC
  if (!authChecked) return <div className="bg-black h-screen flex items-center justify-center text-primary">Loading...</div>;

  // Render Admin Dashboard
  if (isAdminLoggedIn) {
      return <AdminDashboard onLogout={handleAdminLogout} />;
  }

  if (!currentUser) {
      return <AuthScreen onAuthSuccess={onAuthSuccess} onAdminLogin={() => setIsAdminLoggedIn(true)} />;
  }

  return (
    <div className="flex h-screen bg-black text-gray-100 font-sans overflow-hidden" dir="rtl">
      
      {/* Mobile Overlay */}
      {sidebarOpen && (
        <div 
          className="fixed inset-0 bg-black/50 backdrop-blur-sm z-30 md:hidden"
          onClick={() => setSidebarOpen(false)}
        />
      )}

      {/* Sidebar */}
      <aside className={`
        fixed md:relative inset-y-0 right-0 z-40 w-72 bg-[#121212] border-l border-white/5 flex flex-col transition-transform duration-300
        ${sidebarOpen ? 'translate-x-0' : 'translate-x-full md:translate-x-0'}
      `}>
        <div className="p-4 border-b border-white/5 flex items-center justify-between">
           <div className="flex items-center gap-2">
             <div className="bg-gradient-to-br from-primary to-green-600 p-1.5 rounded-lg">
                <Bike size={20} className="text-black" />
             </div>
             <h1 className="font-bold text-lg">StarCycle</h1>
           </div>
           <button onClick={() => setSidebarOpen(false)} className="md:hidden text-gray-400">
             <X size={24} />
           </button>
        </div>

        <div className="p-4">
           <button 
             onClick={() => createNewSession()}
             className="w-full flex items-center gap-2 bg-primary hover:bg-green-400 text-black font-bold py-3 px-4 rounded-xl transition-all shadow-lg shadow-primary/10 hover:shadow-primary/30"
           >
             <Plus size={20} />
             <span>Ú†Øª Ø¬Ø¯ÛŒØ¯</span>
           </button>
        </div>

        <div className="flex-1 overflow-y-auto px-2 space-y-1 scrollbar-thin">
           <h3 className="text-xs font-bold text-gray-500 px-4 py-2">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h3>
           {sessions.map(session => (
             <div 
               key={session.id}
               onClick={() => { setCurrentSessionId(session.id); setSidebarOpen(false); }}
               className={`
                 group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all
                 ${session.id === currentSessionId ? 'bg-white/10 text-white' : 'text-gray-400 hover:bg-white/5 hover:text-gray-200'}
               `}
             >
                <div className="flex items-center gap-3 overflow-hidden">
                    <MessageSquare size={16} className={session.id === currentSessionId ? 'text-primary' : 'text-gray-600'} />
                    <span className="truncate text-sm">{session.title}</span>
                </div>
                <button 
                  onClick={(e) => deleteSession(e, session.id)}
                  className="opacity-0 group-hover:opacity-100 hover:text-red-400 transition-opacity p-1"
                >
                    <Trash2 size={14} />
                </button>
             </div>
           ))}
        </div>
        
        <div className="p-4 border-t border-white/5">
            <div className="flex items-center gap-3 mb-4 px-2">
                <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                    <UserIcon size={16} className="text-primary" />
                </div>
                <div className="flex flex-col">
                    <span className="text-sm font-bold text-white">{currentUser.name} {currentUser.last_name}</span>
                    <span className="text-xs text-gray-500">{currentUser.username}</span>
                </div>
            </div>
            <button 
              onClick={handleLogout}
              className="w-full flex items-center justify-center gap-2 text-red-400 hover:bg-red-500/10 py-2 rounded-lg transition-colors text-sm"
            >
                <LogOut size={16} />
                <span>Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</span>
            </button>
        </div>
      </aside>

      {/* Main Content */}
      <div className="flex-1 flex flex-col relative min-w-0">
        
        {/* Header */}
        <header className="flex items-center justify-between px-4 py-3 bg-[#121212]/80 backdrop-blur-md border-b border-white/5 z-20 absolute top-0 left-0 right-0">
          <div className="flex items-center gap-3">
              <button onClick={() => setSidebarOpen(true)} className="md:hidden text-gray-400">
                  <Menu size={24} />
              </button>
              <div className="flex flex-col">
                  <span className="font-bold text-white text-sm">Mobinext AI</span>
                  <div className="flex items-center gap-1.5">
                      <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse-fast"></span>
                      <span className="text-[10px] text-gray-400">Ø¢Ù†Ù„Ø§ÛŒÙ† Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ</span>
                  </div>
              </div>
          </div>
          
          {/* Comparison Button */}
          {comparisonList.length > 0 && (
             <button 
               onClick={() => setShowComparison(true)}
               className="flex items-center gap-2 bg-yellow-500/10 border border-yellow-500/30 text-yellow-500 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-yellow-500 hover:text-black transition-all animate-fadeIn"
             >
                <Scale size={14} />
                <span>Ù…Ù‚Ø§ÛŒØ³Ù‡ ({comparisonList.length})</span>
             </button>
          )}
        </header>

        {/* Chat Area */}
        <main className="flex-1 overflow-y-auto pt-16 pb-4 px-4 md:px-12 space-y-6 scrollbar-thin">
          {getCurrentMessages().map((msg, idx) => (
            <ChatMessage 
                key={msg.id} 
                message={msg} 
                isLastMessage={idx === getCurrentMessages().length - 1}
                onCompare={toggleComparison}
                compareList={comparisonList}
            />
          ))}
          
          {isLoading && (
             <ChatMessage 
               message={{ id: 'thinking', role: 'model', text: '', isThinking: true, timestamp: Date.now() }} 
               isLastMessage={true}
               onCompare={toggleComparison}
               compareList={comparisonList}
             />
          )}
          
          <div ref={messagesEndRef} />
        </main>

        {/* Input Area */}
        <div className="p-4 bg-gradient-to-t from-black via-black to-transparent">
          <div className="max-w-3xl mx-auto relative flex items-end gap-2 bg-[#1E1E1E] border border-white/10 rounded-3xl p-2 focus-within:border-primary/50 focus-within:shadow-[0_0_20px_rgba(0,208,132,0.1)] transition-all duration-300">
            
            <button 
              onClick={() => setInput('')}
              className="p-3 text-gray-500 hover:text-primary transition-colors hidden md:block" 
              title="Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙˆØ±ÙˆØ¯ÛŒ"
            >
              <Sparkles size={20} />
            </button>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={handleKeyPress}
              placeholder="Ø§Ø² Ù…Ù† Ø¨Ù¾Ø±Ø³... (Ù…Ø«Ù„Ø§Ù‹: Ú©Ù„Ø§Ù‡ Ú©Ø§Ø³Ú©Øª ÙÚ© Ù…ØªØ­Ø±Ú© ØªØ§ Û³ ØªÙˆÙ…Ù†)"
              className="flex-1 bg-transparent text-white placeholder-gray-500 p-3 resize-none focus:outline-none max-h-32 text-sm md:text-base scrollbar-hide leading-relaxed"
              rows={1}
              style={{ minHeight: '48px' }}
            />
            
            <button 
              onClick={handleSend}
              disabled={!input.trim() || isLoading}
              className={`
                w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300
                ${!input.trim() || isLoading 
                  ? 'bg-white/5 text-gray-600 cursor-not-allowed' 
                  : 'bg-primary text-black hover:bg-green-400 hover:scale-110 shadow-lg shadow-primary/20'}
              `}
            >
              <Send size={20} className={isLoading ? 'opacity-0' : 'ml-0.5'} />
            </button>
          </div>
        </div>
      </div>

      {/* Modal */}
      {showComparison && (
          <ComparisonModal 
             products={comparisonList} 
             onClose={() => setShowComparison(false)} 
          />
      )}
    </div>
  );
};

export default App;
-------------------------
.\code.py:
import os

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---

# Ù†Ø§Ù… ÙØ§ÛŒÙ„ÛŒ Ú©Ù‡ Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± Ø¢Ù† Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
output_filename = "project_code_dump.txt"

# Ù„ÛŒØ³Øª Ù¾Ø³ÙˆÙ†Ø¯Ù‡Ø§ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´ÙˆÙ†Ø¯ (ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ÛŒÙ†Ø±ÛŒØŒ ØªØµØ§ÙˆÛŒØ±ØŒ Ùˆ...)
# Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ† Ù„ÛŒØ³Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÛŒØ§Ø² Ø®ÙˆØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯
extensions_to_skip = [
    '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.ico', '.svg',
    '.pdf', '.zip', '.rar', '.tar', '.gz',
    '.exe', '.dll', '.so', '.dylib',
    '.mp3', '.wav', '.mp4', '.avi', '.mov',
    '.ttf', '.woff', '.woff2', '.eot',
    '.pyc', '.pyo', '.pyd'
]

# --- Ø´Ø±ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª ---

print(f"Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø¯Ù‡Ø§... Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± ÙØ§ÛŒÙ„ '{output_filename}' Ø°Ø®ÛŒØ±Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.")

# Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ´ØªÙ† (Ø¨Ø§ Ø§Ù†Ú©Ø¯ÛŒÙ†Ú¯ utf-8 Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² ÙØ§Ø±Ø³ÛŒ)
with open(output_filename, 'w', encoding='utf-8') as outfile:
    # Ù¾ÛŒÙ…Ø§ÛŒØ´ ØªÙ…Ø§Ù… Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ùˆ Ø²ÛŒØ±Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ù…Ø­Ù„ ÙØ¹Ù„ÛŒ ('.')
    for dirpath, dirnames, filenames in os.walk('.'):
        for filename in filenames:
            # Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ Ø®ÙˆØ¯Ø´ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² loop Ø¨ÛŒâ€ŒÙ†Ù‡Ø§ÛŒØª
            if filename == output_filename:
                continue

            # Ø³Ø§Ø®Øª Ù…Ø³ÛŒØ± Ú©Ø§Ù…Ù„ ÙØ§ÛŒÙ„
            full_path = os.path.join(dirpath, filename)

            # Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ùˆ ØºÛŒØ±Ù…ÙÛŒØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø³ÙˆÙ†Ø¯
            if any(filename.lower().endswith(ext) for ext in extensions_to_skip):
                print(f"Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯ (ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒÙ†Ø±ÛŒ): {full_path}")
                continue

            # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§ÛŒÙ„
            try:
                # Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø¨Ø§ Ø§Ù†Ú©Ø¯ÛŒÙ†Ú¯ utf-8
                with open(full_path, 'r', encoding='utf-8') as infile:
                    content = infile.read()

                    # Ù†ÙˆØ´ØªÙ† Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ùˆ Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù† Ø¯Ø± ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§ ÙØ±Ù…Øª Ø®ÙˆØ§Ø³ØªÙ‡ Ø´Ø¯Ù‡
                    outfile.write(f"{full_path}:\n")
                    outfile.write(content)
                    outfile.write("\n" + "-"*25 + "\n")

            except UnicodeDecodeError:
                # Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ø¨Ø§ utf-8 Ø¨Ø§Ø² Ù†Ø´Ø¯ØŒ ÛŒÚ© Ø®Ø·Ø§ Ú†Ø§Ù¾ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ùˆ Ø§Ø² Ø¢Ù† Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ…
                print(f"Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† (Ø§Ù†Ú©Ø¯ÛŒÙ†Ú¯ Ù†Ø§Ù…Ø´Ø®Øµ): {full_path}")
                continue
            except Exception as e:
                # Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§ÛŒØ± Ø®Ø·Ø§Ù‡Ø§ (Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø´ØªÙ† Ø¨Ù‡ ÙØ§ÛŒÙ„)
                print(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ {full_path}: {e}")
                continue

print(f"\nØ¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ…Ø§Ù… Ø´Ø¯! ØªÙ…Ø§Ù… Ú©Ø¯Ù‡Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ '{output_filename}' Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.")
-------------------------
.\index.html:
<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StarCycle - Mobinext AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Vazirmatn', 'sans-serif'],
            },
            colors: {
              primary: '#10b981', // Emerald 500 - Neon Green
              'primary-hover': '#34d399',
              'primary-dim': 'rgba(16, 185, 129, 0.1)',
              background: '#09090b', // Zinc 950
              surface: '#18181b', // Zinc 900
              'surface-lighter': '#27272a', // Zinc 800
              accent: '#f43f5e', // Rose 500
            },
            animation: {
              'fadeIn': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
              'slideUp': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
              'popIn': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              popIn: {
                '0%': { opacity: '0', transform: 'scale(0.9)' },
                '100%': { opacity: '1', transform: 'scale(1)' },
              }
            }
          }
        }
      }
    </script>
  <script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "path": "https://aistudiocdn.com/path@^0.12.7",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "url": "https://aistudiocdn.com/url@^0.11.4",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0",
    "react-markdown": "https://aistudiocdn.com/react-markdown@^10.1.0",
    "vite": "https://aistudiocdn.com/vite@^7.2.7",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.32.0",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.87.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-black text-gray-100">
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>
-------------------------
.\index.tsx:
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
-------------------------
.\metadata.json:
{
  "name": "StarCycle Mobinext Chatbot",
  "description": "A RAG-powered Ecommerce Chatbot for StarCycle using Gemini API and client-side vector simulation.",
  "requestFramePermissions": []
}
-------------------------
.\package.json:
{
  "name": "starcycle-mobinext-chatbot",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^0.2.1",
    "@supabase/supabase-js": "^2.39.7",
    "lucide-react": "^0.475.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-markdown": "^9.0.3"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}
-------------------------
.\README.md:
# StarCycle - Mobinext AI Chatbot

An intelligent conversational AI assistant for StarCycle motorcycle parts store, built with Next.js and powered by artificial intelligence.

## ğŸŒŸ Features

- ğŸ¤– **Intelligent AI Assistant**: Specialized chatbot for motorcycle parts and accessories
- ğŸ‡®ğŸ‡· **Full Persian Language Support**: Complete RTL interface with Vazirmatn font
- ğŸ” **Smart Product Search**: Advanced filtering by category, price, brand, and specifications
- ğŸ“Š **Product Comparison**: Compare up to 3 products simultaneously with detailed specifications
- ğŸ’¬ **Session Management**: Save chat history and create multiple conversation sessions
- âš¡ **Typewriter Effect**: Smooth text animation for enhanced user experience
- ğŸ“± **Responsive Design**: Mobile-first approach with seamless desktop and mobile experience

## ğŸ›  Technology Stack

- **Frontend**: Next.js 15, TypeScript, Tailwind CSS
- **UI Components**: shadcn/ui component library
- **Database**: SQLite with Prisma ORM
- **AI Integration**: Z-AI Web Dev SDK for intelligent responses
- **Icons**: Lucide React for consistent iconography
- **Styling**: Custom CSS animations and dark theme

## ğŸ“ Project Structure

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ chat/          # Chat message processing API
â”‚   â”‚   â””â”€â”€ seed/          # Sample product data API
â”‚   â”œâ”€â”€ globals.css        # Global styles and animations
â”‚   â”œâ”€â”€ layout.tsx         # Root layout component
â”‚   â””â”€â”€ page.tsx          # Main chat interface
â”œâ”€â”€ components/
â”‚   â””â”€â”€ chat/
â”‚       â”œâ”€â”€ ChatMessage.tsx       # Chat message component
â”‚       â”œâ”€â”€ ComparisonModal.tsx    # Product comparison modal
â”‚       â”œâ”€â”€ ProductCard.tsx        # Product display card
â”‚       â””â”€â”€ Typewriter.tsx        # Typing animation effect
â”œâ”€â”€ types/
â”‚   â””â”€â”€ index.ts          # TypeScript type definitions
â””â”€â”€ lib/
    â””â”€â”€ db.ts            # Database connection and configuration
```

## ğŸš€ Getting Started

### Prerequisites

- Node.js 18+ 
- npm or yarn

### Installation

1. **Clone the repository**
```bash
git clone <repository-url>
cd starcycle-mobinext-chatbot
```

2. **Install dependencies**
```bash
npm install
```

3. **Set up the database**
```bash
npm run db:push
```

4. **Add sample products (optional)**
```bash
curl -X POST http://localhost:3000/api/seed
```

5. **Start the development server**
```bash
npm run dev
```

6. **Open your browser**
Navigate to `http://localhost:3000`

## ğŸ’¡ Usage Guide

### Basic Interaction

1. **Start a conversation**: The AI assistant will greet you in Persian
2. **Ask about products**: Use natural language to describe what you're looking for
3. **View recommendations**: Browse through suggested products with detailed information
4. **Compare products**: Add items to comparison list for side-by-side analysis
5. **Manage sessions**: Create new chats or switch between previous conversations

### Sample Queries

- "Ú©Ù„Ø§Ù‡ Ú©Ø§Ø³Ú©Øª ÙÚ© Ù…ØªØ­Ø±Ú© ØªØ§ Û³ Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†" (Full-face helmet up to 3M Toman)
- "Ø±ÙˆØºÙ† Ù…ÙˆØªÙˆØ± 4 Ø²Ù…Ø§Ù†Ù‡ 1 Ù„ÛŒØªØ±ÛŒ" (4-stroke 1-liter engine oil)
- "Ù„Ø§Ø³ØªÛŒÚ© Ø§Ø³Ù¾Ø±Øª Ø¨Ø±Ø§ÛŒ ÛŒØ§Ù…Ø§Ù‡Ø§ R6" (Sport tires for Yamaha R6)
- "Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ú¯Ø²ÙˆØ² Ø¨Ø±Ø§ÛŒ Ù…ÙˆØªÙˆØ± Ø§Ø³Ù¾Ø±Øª" (Best exhaust for sport motorcycle)

### Search Capabilities

- **Category**: Helmets, engine oil, tires, batteries, exhaust systems, etc.
- **Price Range**: Filter products based on your budget
- **Brand**: Search by specific manufacturer
- **Technical Specs**: Size, volume, model, and other specifications

## ğŸ¯ Key Features Explained

### AI-Powered Sales Assistant

The chatbot follows a sophisticated 3-stage sales funnel:

1. **Discovery Phase**: Asks targeted questions about technical specifications
2. **Confirmation Phase**: Summarizes requirements before searching
3. **Action Phase**: Provides relevant product recommendations

### Smart Product Matching

- **Exact Matches**: Products matching all specified criteria
- **Close Matches**: Similar products within price tolerance (70/30 rule)
- **Intelligent Ranking**: Products ranked by relevance and price proximity

### Comparison System

- **Side-by-Side View**: Detailed comparison table with specifications
- **Visual Comparison**: Product images and key features
- **Quick Actions**: Direct purchase links for each product

## ğŸ”§ Development

### Adding New Features

1. **Database Changes**: Update `prisma/schema.prisma` and run `npm run db:push`
2. **API Endpoints**: Create new routes in `src/app/api/`
3. **Components**: Build reusable components in `src/components/`
4. **Types**: Define TypeScript interfaces in `src/types/`

### Code Quality

```bash
# Run linting
npm run lint

# Type checking
npm run type-check

# Build for production
npm run build
```

## ğŸ“Š Database Schema

The application uses SQLite with the following main models:

- **Product**: Stores product information, pricing, and specifications
- **ChatSession**: Manages conversation history and user sessions
- **User**: User account information (for future authentication)

## ğŸ¨ Design System

### Color Palette
- **Primary**: Emerald Green (#10b981) - Represents growth and reliability
- **Background**: Dark theme (#09090b) - Reduces eye strain
- **Surface**: Card backgrounds (#18181b) - Content hierarchy
- **Accent**: Rose (#f43f5e) - Call-to-action elements

### Typography
- **Primary Font**: Vazirmatn (Persian script)
- **Fallback**: System fonts for non-Persian content
- **Weights**: 200-800 for comprehensive hierarchy

### Animations
- **Fade In**: Smooth appearance of new elements
- **Slide Up**: Content entrance from bottom
- **Typewriter**: Progressive text reveal
- **Pulse**: Loading and attention states

## ğŸ”’ Security & Performance

- **Input Validation**: All user inputs are sanitized and validated
- **SQL Injection Prevention**: Prisma ORM provides parameterized queries
- **XSS Protection**: React's built-in XSS prevention
- **Performance**: Optimized images and lazy loading
- **Caching**: Database query optimization and response caching

## ğŸŒ Deployment

### Environment Variables

Create a `.env.local` file with:

```env
DATABASE_URL="file:./dev.db"
# Add other environment-specific variables here
```

### Production Deployment

1. **Build the application**
```bash
npm run build
```

2. **Start production server**
```bash
npm start
```

3. **Deploy to your preferred platform** (Vercel, Netlify, Railway, etc.)

## ğŸ¤ Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## ğŸ“„ License

This project is proprietary and developed exclusively for StarCycle by Mobinext.

## ğŸ“ Support

For technical support or questions:
- **Development Team**: Mobinext
- **Client**: StarCycle Motorcycle Parts Store

---

**Built with â¤ï¸ by Mobinext for StarCycle**
-------------------------
.\SQL.txt:
-- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
-- Ø§ÛŒÙ† Ú©Ø¯Ù‡Ø§ Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø± Ø¨Ø®Ø´ SQL Editor Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Supabase Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.

-- 1. Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (users)
CREATE TABLE IF NOT EXISTS users (
  user_id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  number TEXT UNIQUE NOT NULL,
  username TEXT UNIQUE NOT NULL,
  name TEXT,
  last_name TEXT,
  pass TEXT NOT NULL,
  signup_Date TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- 2. Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„ Ù†Ø´Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ú†Øª (chat_sessions)
CREATE TABLE IF NOT EXISTS chat_sessions (
  id TEXT PRIMARY KEY,
  user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
  title TEXT,
  messages JSONB,
  last_modified TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
ALTER TABLE chat_sessions ENABLE ROW LEVEL SECURITY;

-- Ø§ÛŒØ¬Ø§Ø¯ Ø§ÛŒÙ†Ø¯Ú©Ø³
CREATE INDEX IF NOT EXISTS idx_chat_sessions_user_id ON chat_sessions(user_id);

-- 3. Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„ Ø§Ø¯Ù…ÛŒÙ† (admins)
CREATE TABLE IF NOT EXISTS admins (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  pass TEXT NOT NULL
);
ALTER TABLE admins ENABLE ROW LEVEL SECURITY;









CREATE TABLE IF NOT EXISTS public.admins (
    id SERIAL PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    pass TEXT NOT NULL
);



INSERT INTO public.admins (username, pass)
VALUES ('Admin', 'Admin')
ON CONFLICT (username) DO NOTHING;



ALTER TABLE public.admins ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable read access for admins"
ON public.admins
FOR SELECT
TO anon
USING (true);

-------------------------
.\tsconfig.json:
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}
-------------------------
.\types.ts:
export interface Product {
  id?: string | number;
  title: string;
  price: number | string;
  link: string;
  image?: string;
  category?: string;
  features?: string[]; // Simplified from JSON structure
  description?: string;
}

export interface ProductMatch extends Product {
  isCloseMatch?: boolean;
  matchReason?: string;
}

export interface ChatMessage {
  id: string;
  role: 'user' | 'model' | 'system';
  text: string;
  products?: ProductMatch[];
  isThinking?: boolean;
  timestamp?: number;
}

export interface Session {
  id: string;
  title: string;
  messages: ChatMessage[];
  lastModified: number;
}

export interface User {
  user_id: string;
  number: string;
  username: string;
  name: string;
  last_name: string;
  signup_Date: string;
}

export interface FilterParams {
  category?: string;
  min_price?: number;
  max_price?: number;
  keywords?: string;
  brand?: string;
}

export const DATA_URL = "https://raw.githubusercontent.com/RezaSbu/Database/refs/heads/main/optimized_products_final_updated.json";
-------------------------
.\vite.config.ts:
import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      server: {
        port: 3000,
        host: '0.0.0.0',
      },
      plugins: [],
      define: {
        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.SUPABASE_URL': JSON.stringify("https://jhjlxljhijhrvclgsbzc.supabase.co"),
        'process.env.SUPABASE_KEY': JSON.stringify("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impoamx4bGpoaWpocnZjbGdzYnpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjQ4NzYsImV4cCI6MjA4MDg0MDg3Nn0.8WwtsrOE3Fch_vFczeu6Fz9A2QiO_Pbwh_MxuhFUFwY")
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      }
    };
});
-------------------------
.\.git\COMMIT_EDITMSG:
Admin Database and Dashboard

-------------------------
.\.git\config:
[core]
	repositoryformatversion = 0
	filemode = false
	bare = false
	logallrefupdates = true
	symlinks = false
	ignorecase = true
[remote "origin"]
	url = https://github.com/RezaSbu/NeuraQueen.git
	fetch = +refs/heads/*:refs/remotes/origin/*
[branch "main"]
	remote = origin
	merge = refs/heads/main
	vscode-merge-base = origin/main
[branch "V1.1"]
	vscode-merge-base = origin/main
	remote = origin
	merge = refs/heads/V1.1
[branch "Login"]
	remote = origin
	merge = refs/heads/Login
	vscode-merge-base = origin/main

-------------------------
.\.git\description:
Unnamed repository; edit this file 'description' to name the repository.

-------------------------
.\.git\FETCH_HEAD:
cc0a61c89453efaef6617dcea8ec942d7771c22b		branch 'main' of https://github.com/RezaSbu/NeuraQueen
7ec4c17df8d876639885cee888056ce707dfd69a	not-for-merge	branch 'V1.1' of https://github.com/RezaSbu/NeuraQueen

-------------------------
.\.git\HEAD:
ref: refs/heads/Login

-------------------------
.\.git\ORIG_HEAD:
38816cfd89f9c033a4f52c4722b792a9ced985cb

-------------------------
.\.git\packed-refs:
# pack-refs with: peeled fully-peeled sorted 
430a1e71314e0b97caa64260716e0cca74a0f76b refs/remotes/origin/main

-------------------------
.\.git\hooks\applypatch-msg.sample:
#!/bin/sh
#
# An example hook script to check the commit log message taken by
# applypatch from an e-mail message.
#
# The hook should exit with non-zero status after issuing an
# appropriate message if it wants to stop the commit.  The hook is
# allowed to edit the commit message file.
#
# To enable this hook, rename this file to "applypatch-msg".

. git-sh-setup
commitmsg="$(git rev-parse --git-path hooks/commit-msg)"
test -x "$commitmsg" && exec "$commitmsg" ${1+"$@"}
:

-------------------------
.\.git\hooks\commit-msg.sample:
#!/bin/sh
#
# An example hook script to check the commit log message.
# Called by "git commit" with one argument, the name of the file
# that has the commit message.  The hook should exit with non-zero
# status after issuing an appropriate message if it wants to stop the
# commit.  The hook is allowed to edit the commit message file.
#
# To enable this hook, rename this file to "commit-msg".

# Uncomment the below to add a Signed-off-by line to the message.
# Doing this in a hook is a bad idea in general, but the prepare-commit-msg
# hook is more suited to it.
#
# SOB=$(git var GIT_AUTHOR_IDENT | sed -n 's/^\(.*>\).*$/Signed-off-by: \1/p')
# grep -qs "^$SOB" "$1" || echo "$SOB" >> "$1"

# This example catches duplicate Signed-off-by lines.

test "" = "$(grep '^Signed-off-by: ' "$1" |
	 sort | uniq -c | sed -e '/^[ 	]*1[ 	]/d')" || {
	echo >&2 Duplicate Signed-off-by lines.
	exit 1
}

-------------------------
.\.git\hooks\fsmonitor-watchman.sample:
#!/usr/bin/perl

use strict;
use warnings;
use IPC::Open2;

# An example hook script to integrate Watchman
# (https://facebook.github.io/watchman/) with git to speed up detecting
# new and modified files.
#
# The hook is passed a version (currently 2) and last update token
# formatted as a string and outputs to stdout a new update token and
# all files that have been modified since the update token. Paths must
# be relative to the root of the working tree and separated by a single NUL.
#
# To enable this hook, rename this file to "query-watchman" and set
# 'git config core.fsmonitor .git/hooks/query-watchman'
#
my ($version, $last_update_token) = @ARGV;

# Uncomment for debugging
# print STDERR "$0 $version $last_update_token\n";

# Check the hook interface version
if ($version ne 2) {
	die "Unsupported query-fsmonitor hook version '$version'.\n" .
	    "Falling back to scanning...\n";
}

my $git_work_tree = get_working_dir();

my $retry = 1;

my $json_pkg;
eval {
	require JSON::XS;
	$json_pkg = "JSON::XS";
	1;
} or do {
	require JSON::PP;
	$json_pkg = "JSON::PP";
};

launch_watchman();

sub launch_watchman {
	my $o = watchman_query();
	if (is_work_tree_watched($o)) {
		output_result($o->{clock}, @{$o->{files}});
	}
}

sub output_result {
	my ($clockid, @files) = @_;

	# Uncomment for debugging watchman output
	# open (my $fh, ">", ".git/watchman-output.out");
	# binmode $fh, ":utf8";
	# print $fh "$clockid\n@files\n";
	# close $fh;

	binmode STDOUT, ":utf8";
	print $clockid;
	print "\0";
	local $, = "\0";
	print @files;
}

sub watchman_clock {
	my $response = qx/watchman clock "$git_work_tree"/;
	die "Failed to get clock id on '$git_work_tree'.\n" .
		"Falling back to scanning...\n" if $? != 0;

	return $json_pkg->new->utf8->decode($response);
}

sub watchman_query {
	my $pid = open2(\*CHLD_OUT, \*CHLD_IN, 'watchman -j --no-pretty')
	or die "open2() failed: $!\n" .
	"Falling back to scanning...\n";

	# In the query expression below we're asking for names of files that
	# changed since $last_update_token but not from the .git folder.
	#
	# To accomplish this, we're using the "since" generator to use the
	# recency index to select candidate nodes and "fields" to limit the
	# output to file names only. Then we're using the "expression" term to
	# further constrain the results.
	my $last_update_line = "";
	if (substr($last_update_token, 0, 1) eq "c") {
		$last_update_token = "\"$last_update_token\"";
		$last_update_line = qq[\n"since": $last_update_token,];
	}
	my $query = <<"	END";
		["query", "$git_work_tree", {$last_update_line
			"fields": ["name"],
			"expression": ["not", ["dirname", ".git"]]
		}]
	END

	# Uncomment for debugging the watchman query
	# open (my $fh, ">", ".git/watchman-query.json");
	# print $fh $query;
	# close $fh;

	print CHLD_IN $query;
	close CHLD_IN;
	my $response = do {local $/; <CHLD_OUT>};

	# Uncomment for debugging the watch response
	# open ($fh, ">", ".git/watchman-response.json");
	# print $fh $response;
	# close $fh;

	die "Watchman: command returned no output.\n" .
	"Falling back to scanning...\n" if $response eq "";
	die "Watchman: command returned invalid output: $response\n" .
	"Falling back to scanning...\n" unless $response =~ /^\{/;

	return $json_pkg->new->utf8->decode($response);
}

sub is_work_tree_watched {
	my ($output) = @_;
	my $error = $output->{error};
	if ($retry > 0 and $error and $error =~ m/unable to resolve root .* directory (.*) is not watched/) {
		$retry--;
		my $response = qx/watchman watch "$git_work_tree"/;
		die "Failed to make watchman watch '$git_work_tree'.\n" .
		    "Falling back to scanning...\n" if $? != 0;
		$output = $json_pkg->new->utf8->decode($response);
		$error = $output->{error};
		die "Watchman: $error.\n" .
		"Falling back to scanning...\n" if $error;

		# Uncomment for debugging watchman output
		# open (my $fh, ">", ".git/watchman-output.out");
		# close $fh;

		# Watchman will always return all files on the first query so
		# return the fast "everything is dirty" flag to git and do the
		# Watchman query just to get it over with now so we won't pay
		# the cost in git to look up each individual file.
		my $o = watchman_clock();
		$error = $output->{error};

		die "Watchman: $error.\n" .
		"Falling back to scanning...\n" if $error;

		output_result($o->{clock}, ("/"));
		$last_update_token = $o->{clock};

		eval { launch_watchman() };
		return 0;
	}

	die "Watchman: $error.\n" .
	"Falling back to scanning...\n" if $error;

	return 1;
}

sub get_working_dir {
	my $working_dir;
	if ($^O =~ 'msys' || $^O =~ 'cygwin') {
		$working_dir = Win32::GetCwd();
		$working_dir =~ tr/\\/\//;
	} else {
		require Cwd;
		$working_dir = Cwd::cwd();
	}

	return $working_dir;
}

-------------------------
.\.git\hooks\post-update.sample:
#!/bin/sh
#
# An example hook script to prepare a packed repository for use over
# dumb transports.
#
# To enable this hook, rename this file to "post-update".

exec git update-server-info

-------------------------
.\.git\hooks\pre-applypatch.sample:
#!/bin/sh
#
# An example hook script to verify what is about to be committed
# by applypatch from an e-mail message.
#
# The hook should exit with non-zero status after issuing an
# appropriate message if it wants to stop the commit.
#
# To enable this hook, rename this file to "pre-applypatch".

. git-sh-setup
precommit="$(git rev-parse --git-path hooks/pre-commit)"
test -x "$precommit" && exec "$precommit" ${1+"$@"}
:

-------------------------
.\.git\hooks\pre-commit.sample:
#!/bin/sh
#
# An example hook script to verify what is about to be committed.
# Called by "git commit" with no arguments.  The hook should
# exit with non-zero status after issuing an appropriate message if
# it wants to stop the commit.
#
# To enable this hook, rename this file to "pre-commit".

if git rev-parse --verify HEAD >/dev/null 2>&1
then
	against=HEAD
else
	# Initial commit: diff against an empty tree object
	against=$(git hash-object -t tree /dev/null)
fi

# If you want to allow non-ASCII filenames set this variable to true.
allownonascii=$(git config --type=bool hooks.allownonascii)

# Redirect output to stderr.
exec 1>&2

# Cross platform projects tend to avoid non-ASCII filenames; prevent
# them from being added to the repository. We exploit the fact that the
# printable range starts at the space character and ends with tilde.
if [ "$allownonascii" != "true" ] &&
	# Note that the use of brackets around a tr range is ok here, (it's
	# even required, for portability to Solaris 10's /usr/bin/tr), since
	# the square bracket bytes happen to fall in the designated range.
	test $(git diff-index --cached --name-only --diff-filter=A -z $against |
	  LC_ALL=C tr -d '[ -~]\0' | wc -c) != 0
then
	cat <<\EOF
Error: Attempt to add a non-ASCII file name.

This can cause problems if you want to work with people on other platforms.

To be portable it is advisable to rename the file.

If you know what you are doing you can disable this check using:

  git config hooks.allownonascii true
EOF
	exit 1
fi

# If there are whitespace errors, print the offending file names and fail.
exec git diff-index --check --cached $against --

-------------------------
.\.git\hooks\pre-merge-commit.sample:
#!/bin/sh
#
# An example hook script to verify what is about to be committed.
# Called by "git merge" with no arguments.  The hook should
# exit with non-zero status after issuing an appropriate message to
# stderr if it wants to stop the merge commit.
#
# To enable this hook, rename this file to "pre-merge-commit".

. git-sh-setup
test -x "$GIT_DIR/hooks/pre-commit" &&
        exec "$GIT_DIR/hooks/pre-commit"
:

-------------------------
.\.git\hooks\pre-push.sample:
#!/bin/sh

# An example hook script to verify what is about to be pushed.  Called by "git
# push" after it has checked the remote status, but before anything has been
# pushed.  If this script exits with a non-zero status nothing will be pushed.
#
# This hook is called with the following parameters:
#
# $1 -- Name of the remote to which the push is being done
# $2 -- URL to which the push is being done
#
# If pushing without using a named remote those arguments will be equal.
#
# Information about the commits which are being pushed is supplied as lines to
# the standard input in the form:
#
#   <local ref> <local oid> <remote ref> <remote oid>
#
# This sample shows how to prevent push of commits where the log message starts
# with "WIP" (work in progress).

remote="$1"
url="$2"

zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')

while read local_ref local_oid remote_ref remote_oid
do
	if test "$local_oid" = "$zero"
	then
		# Handle delete
		:
	else
		if test "$remote_oid" = "$zero"
		then
			# New branch, examine all commits
			range="$local_oid"
		else
			# Update to existing branch, examine new commits
			range="$remote_oid..$local_oid"
		fi

		# Check for WIP commit
		commit=$(git rev-list -n 1 --grep '^WIP' "$range")
		if test -n "$commit"
		then
			echo >&2 "Found WIP commit in $local_ref, not pushing"
			exit 1
		fi
	fi
done

exit 0

-------------------------
.\.git\hooks\pre-rebase.sample:
#!/bin/sh
#
# Copyright (c) 2006, 2008 Junio C Hamano
#
# The "pre-rebase" hook is run just before "git rebase" starts doing
# its job, and can prevent the command from running by exiting with
# non-zero status.
#
# The hook is called with the following parameters:
#
# $1 -- the upstream the series was forked from.
# $2 -- the branch being rebased (or empty when rebasing the current branch).
#
# This sample shows how to prevent topic branches that are already
# merged to 'next' branch from getting rebased, because allowing it
# would result in rebasing already published history.

publish=next
basebranch="$1"
if test "$#" = 2
then
	topic="refs/heads/$2"
else
	topic=`git symbolic-ref HEAD` ||
	exit 0 ;# we do not interrupt rebasing detached HEAD
fi

case "$topic" in
refs/heads/??/*)
	;;
*)
	exit 0 ;# we do not interrupt others.
	;;
esac

# Now we are dealing with a topic branch being rebased
# on top of master.  Is it OK to rebase it?

# Does the topic really exist?
git show-ref -q "$topic" || {
	echo >&2 "No such branch $topic"
	exit 1
}

# Is topic fully merged to master?
not_in_master=`git rev-list --pretty=oneline ^master "$topic"`
if test -z "$not_in_master"
then
	echo >&2 "$topic is fully merged to master; better remove it."
	exit 1 ;# we could allow it, but there is no point.
fi

# Is topic ever merged to next?  If so you should not be rebasing it.
only_next_1=`git rev-list ^master "^$topic" ${publish} | sort`
only_next_2=`git rev-list ^master           ${publish} | sort`
if test "$only_next_1" = "$only_next_2"
then
	not_in_topic=`git rev-list "^$topic" master`
	if test -z "$not_in_topic"
	then
		echo >&2 "$topic is already up to date with master"
		exit 1 ;# we could allow it, but there is no point.
	else
		exit 0
	fi
else
	not_in_next=`git rev-list --pretty=oneline ^${publish} "$topic"`
	/usr/bin/perl -e '
		my $topic = $ARGV[0];
		my $msg = "* $topic has commits already merged to public branch:\n";
		my (%not_in_next) = map {
			/^([0-9a-f]+) /;
			($1 => 1);
		} split(/\n/, $ARGV[1]);
		for my $elem (map {
				/^([0-9a-f]+) (.*)$/;
				[$1 => $2];
			} split(/\n/, $ARGV[2])) {
			if (!exists $not_in_next{$elem->[0]}) {
				if ($msg) {
					print STDERR $msg;
					undef $msg;
				}
				print STDERR " $elem->[1]\n";
			}
		}
	' "$topic" "$not_in_next" "$not_in_master"
	exit 1
fi

<<\DOC_END

This sample hook safeguards topic branches that have been
published from being rewound.

The workflow assumed here is:

 * Once a topic branch forks from "master", "master" is never
   merged into it again (either directly or indirectly).

 * Once a topic branch is fully cooked and merged into "master",
   it is deleted.  If you need to build on top of it to correct
   earlier mistakes, a new topic branch is created by forking at
   the tip of the "master".  This is not strictly necessary, but
   it makes it easier to keep your history simple.

 * Whenever you need to test or publish your changes to topic
   branches, merge them into "next" branch.

The script, being an example, hardcodes the publish branch name
to be "next", but it is trivial to make it configurable via
$GIT_DIR/config mechanism.

With this workflow, you would want to know:

(1) ... if a topic branch has ever been merged to "next".  Young
    topic branches can have stupid mistakes you would rather
    clean up before publishing, and things that have not been
    merged into other branches can be easily rebased without
    affecting other people.  But once it is published, you would
    not want to rewind it.

(2) ... if a topic branch has been fully merged to "master".
    Then you can delete it.  More importantly, you should not
    build on top of it -- other people may already want to
    change things related to the topic as patches against your
    "master", so if you need further changes, it is better to
    fork the topic (perhaps with the same name) afresh from the
    tip of "master".

Let's look at this example:

		   o---o---o---o---o---o---o---o---o---o "next"
		  /       /           /           /
		 /   a---a---b A     /           /
		/   /               /           /
	       /   /   c---c---c---c B         /
	      /   /   /             \         /
	     /   /   /   b---b C     \       /
	    /   /   /   /             \     /
    ---o---o---o---o---o---o---o---o---o---o---o "master"


A, B and C are topic branches.

 * A has one fix since it was merged up to "next".

 * B has finished.  It has been fully merged up to "master" and "next",
   and is ready to be deleted.

 * C has not merged to "next" at all.

We would want to allow C to be rebased, refuse A, and encourage
B to be deleted.

To compute (1):

	git rev-list ^master ^topic next
	git rev-list ^master        next

	if these match, topic has not merged in next at all.

To compute (2):

	git rev-list master..topic

	if this is empty, it is fully merged to "master".

DOC_END

-------------------------
.\.git\hooks\pre-receive.sample:
#!/bin/sh
#
# An example hook script to make use of push options.
# The example simply echoes all push options that start with 'echoback='
# and rejects all pushes when the "reject" push option is used.
#
# To enable this hook, rename this file to "pre-receive".

if test -n "$GIT_PUSH_OPTION_COUNT"
then
	i=0
	while test "$i" -lt "$GIT_PUSH_OPTION_COUNT"
	do
		eval "value=\$GIT_PUSH_OPTION_$i"
		case "$value" in
		echoback=*)
			echo "echo from the pre-receive-hook: ${value#*=}" >&2
			;;
		reject)
			exit 1
		esac
		i=$((i + 1))
	done
fi

-------------------------
.\.git\hooks\prepare-commit-msg.sample:
#!/bin/sh
#
# An example hook script to prepare the commit log message.
# Called by "git commit" with the name of the file that has the
# commit message, followed by the description of the commit
# message's source.  The hook's purpose is to edit the commit
# message file.  If the hook fails with a non-zero status,
# the commit is aborted.
#
# To enable this hook, rename this file to "prepare-commit-msg".

# This hook includes three examples. The first one removes the
# "# Please enter the commit message..." help message.
#
# The second includes the output of "git diff --name-status -r"
# into the message, just before the "git status" output.  It is
# commented because it doesn't cope with --amend or with squashed
# commits.
#
# The third example adds a Signed-off-by line to the message, that can
# still be edited.  This is rarely a good idea.

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

/usr/bin/perl -i.bak -ne 'print unless(m/^. Please enter the commit message/..m/^#$/)' "$COMMIT_MSG_FILE"

# case "$COMMIT_SOURCE,$SHA1" in
#  ,|template,)
#    /usr/bin/perl -i.bak -pe '
#       print "\n" . `git diff --cached --name-status -r`
# 	 if /^#/ && $first++ == 0' "$COMMIT_MSG_FILE" ;;
#  *) ;;
# esac

# SOB=$(git var GIT_COMMITTER_IDENT | sed -n 's/^\(.*>\).*$/Signed-off-by: \1/p')
# git interpret-trailers --in-place --trailer "$SOB" "$COMMIT_MSG_FILE"
# if test -z "$COMMIT_SOURCE"
# then
#   /usr/bin/perl -i.bak -pe 'print "\n" if !$first_line++' "$COMMIT_MSG_FILE"
# fi

-------------------------
.\.git\hooks\push-to-checkout.sample:
#!/bin/sh

# An example hook script to update a checked-out tree on a git push.
#
# This hook is invoked by git-receive-pack(1) when it reacts to git
# push and updates reference(s) in its repository, and when the push
# tries to update the branch that is currently checked out and the
# receive.denyCurrentBranch configuration variable is set to
# updateInstead.
#
# By default, such a push is refused if the working tree and the index
# of the remote repository has any difference from the currently
# checked out commit; when both the working tree and the index match
# the current commit, they are updated to match the newly pushed tip
# of the branch. This hook is to be used to override the default
# behaviour; however the code below reimplements the default behaviour
# as a starting point for convenient modification.
#
# The hook receives the commit with which the tip of the current
# branch is going to be updated:
commit=$1

# It can exit with a non-zero status to refuse the push (when it does
# so, it must not modify the index or the working tree).
die () {
	echo >&2 "$*"
	exit 1
}

# Or it can make any necessary changes to the working tree and to the
# index to bring them to the desired state when the tip of the current
# branch is updated to the new commit, and exit with a zero status.
#
# For example, the hook can simply run git read-tree -u -m HEAD "$1"
# in order to emulate git fetch that is run in the reverse direction
# with git push, as the two-tree form of git read-tree -u -m is
# essentially the same as git switch or git checkout that switches
# branches while keeping the local changes in the working tree that do
# not interfere with the difference between the branches.

# The below is a more-or-less exact translation to shell of the C code
# for the default behaviour for git's push-to-checkout hook defined in
# the push_to_deploy() function in builtin/receive-pack.c.
#
# Note that the hook will be executed from the repository directory,
# not from the working tree, so if you want to perform operations on
# the working tree, you will have to adapt your code accordingly, e.g.
# by adding "cd .." or using relative paths.

if ! git update-index -q --ignore-submodules --refresh
then
	die "Up-to-date check failed"
fi

if ! git diff-files --quiet --ignore-submodules --
then
	die "Working directory has unstaged changes"
fi

# This is a rough translation of:
#
#   head_has_history() ? "HEAD" : EMPTY_TREE_SHA1_HEX
if git cat-file -e HEAD 2>/dev/null
then
	head=HEAD
else
	head=$(git hash-object -t tree --stdin </dev/null)
fi

if ! git diff-index --quiet --cached --ignore-submodules $head --
then
	die "Working directory has staged changes"
fi

if ! git read-tree -u -m "$commit"
then
	die "Could not update working tree to new HEAD"
fi

-------------------------
.\.git\hooks\sendemail-validate.sample:
#!/bin/sh

# An example hook script to validate a patch (and/or patch series) before
# sending it via email.
#
# The hook should exit with non-zero status after issuing an appropriate
# message if it wants to prevent the email(s) from being sent.
#
# To enable this hook, rename this file to "sendemail-validate".
#
# By default, it will only check that the patch(es) can be applied on top of
# the default upstream branch without conflicts in a secondary worktree. After
# validation (successful or not) of the last patch of a series, the worktree
# will be deleted.
#
# The following config variables can be set to change the default remote and
# remote ref that are used to apply the patches against:
#
#   sendemail.validateRemote (default: origin)
#   sendemail.validateRemoteRef (default: HEAD)
#
# Replace the TODO placeholders with appropriate checks according to your
# needs.

validate_cover_letter () {
	file="$1"
	# TODO: Replace with appropriate checks (e.g. spell checking).
	true
}

validate_patch () {
	file="$1"
	# Ensure that the patch applies without conflicts.
	git am -3 "$file" || return
	# TODO: Replace with appropriate checks for this patch
	# (e.g. checkpatch.pl).
	true
}

validate_series () {
	# TODO: Replace with appropriate checks for the whole series
	# (e.g. quick build, coding style checks, etc.).
	true
}

# main -------------------------------------------------------------------------

if test "$GIT_SENDEMAIL_FILE_COUNTER" = 1
then
	remote=$(git config --default origin --get sendemail.validateRemote) &&
	ref=$(git config --default HEAD --get sendemail.validateRemoteRef) &&
	worktree=$(mktemp --tmpdir -d sendemail-validate.XXXXXXX) &&
	git worktree add -fd --checkout "$worktree" "refs/remotes/$remote/$ref" &&
	git config --replace-all sendemail.validateWorktree "$worktree"
else
	worktree=$(git config --get sendemail.validateWorktree)
fi || {
	echo "sendemail-validate: error: failed to prepare worktree" >&2
	exit 1
}

unset GIT_DIR GIT_WORK_TREE
cd "$worktree" &&

if grep -q "^diff --git " "$1"
then
	validate_patch "$1"
else
	validate_cover_letter "$1"
fi &&

if test "$GIT_SENDEMAIL_FILE_COUNTER" = "$GIT_SENDEMAIL_FILE_TOTAL"
then
	git config --unset-all sendemail.validateWorktree &&
	trap 'git worktree remove -ff "$worktree"' EXIT &&
	validate_series
fi

-------------------------
.\.git\hooks\update.sample:
#!/bin/sh
#
# An example hook script to block unannotated tags from entering.
# Called by "git receive-pack" with arguments: refname sha1-old sha1-new
#
# To enable this hook, rename this file to "update".
#
# Config
# ------
# hooks.allowunannotated
#   This boolean sets whether unannotated tags will be allowed into the
#   repository.  By default they won't be.
# hooks.allowdeletetag
#   This boolean sets whether deleting tags will be allowed in the
#   repository.  By default they won't be.
# hooks.allowmodifytag
#   This boolean sets whether a tag may be modified after creation. By default
#   it won't be.
# hooks.allowdeletebranch
#   This boolean sets whether deleting branches will be allowed in the
#   repository.  By default they won't be.
# hooks.denycreatebranch
#   This boolean sets whether remotely creating branches will be denied
#   in the repository.  By default this is allowed.
#

# --- Command line
refname="$1"
oldrev="$2"
newrev="$3"

# --- Safety check
if [ -z "$GIT_DIR" ]; then
	echo "Don't run this script from the command line." >&2
	echo " (if you want, you could supply GIT_DIR then run" >&2
	echo "  $0 <ref> <oldrev> <newrev>)" >&2
	exit 1
fi

if [ -z "$refname" -o -z "$oldrev" -o -z "$newrev" ]; then
	echo "usage: $0 <ref> <oldrev> <newrev>" >&2
	exit 1
fi

# --- Config
allowunannotated=$(git config --type=bool hooks.allowunannotated)
allowdeletebranch=$(git config --type=bool hooks.allowdeletebranch)
denycreatebranch=$(git config --type=bool hooks.denycreatebranch)
allowdeletetag=$(git config --type=bool hooks.allowdeletetag)
allowmodifytag=$(git config --type=bool hooks.allowmodifytag)

# check for no description
projectdesc=$(sed -e '1q' "$GIT_DIR/description")
case "$projectdesc" in
"Unnamed repository"* | "")
	echo "*** Project description file hasn't been set" >&2
	exit 1
	;;
esac

# --- Check types
# if $newrev is 0000...0000, it's a commit to delete a ref.
zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')
if [ "$newrev" = "$zero" ]; then
	newrev_type=delete
else
	newrev_type=$(git cat-file -t $newrev)
fi

case "$refname","$newrev_type" in
	refs/tags/*,commit)
		# un-annotated tag
		short_refname=${refname##refs/tags/}
		if [ "$allowunannotated" != "true" ]; then
			echo "*** The un-annotated tag, $short_refname, is not allowed in this repository" >&2
			echo "*** Use 'git tag [ -a | -s ]' for tags you want to propagate." >&2
			exit 1
		fi
		;;
	refs/tags/*,delete)
		# delete tag
		if [ "$allowdeletetag" != "true" ]; then
			echo "*** Deleting a tag is not allowed in this repository" >&2
			exit 1
		fi
		;;
	refs/tags/*,tag)
		# annotated tag
		if [ "$allowmodifytag" != "true" ] && git rev-parse $refname > /dev/null 2>&1
		then
			echo "*** Tag '$refname' already exists." >&2
			echo "*** Modifying a tag is not allowed in this repository." >&2
			exit 1
		fi
		;;
	refs/heads/*,commit)
		# branch
		if [ "$oldrev" = "$zero" -a "$denycreatebranch" = "true" ]; then
			echo "*** Creating a branch is not allowed in this repository" >&2
			exit 1
		fi
		;;
	refs/heads/*,delete)
		# delete branch
		if [ "$allowdeletebranch" != "true" ]; then
			echo "*** Deleting a branch is not allowed in this repository" >&2
			exit 1
		fi
		;;
	refs/remotes/*,commit)
		# tracking branch
		;;
	refs/remotes/*,delete)
		# delete tracking branch
		if [ "$allowdeletebranch" != "true" ]; then
			echo "*** Deleting a tracking branch is not allowed in this repository" >&2
			exit 1
		fi
		;;
	*)
		# Anything else (is there anything else?)
		echo "*** Update hook: unknown type of update to ref $refname of type $newrev_type" >&2
		exit 1
		;;
esac

# --- Finished
exit 0

-------------------------
.\.git\info\exclude:
# git ls-files --others --exclude-from=.git/info/exclude
# Lines that start with '#' are comments.
# For a project mostly in C, the following would be a good set of
# exclude patterns (uncomment them if you want to use them):
# *.[oa]
# *~

-------------------------
.\.git\logs\HEAD:
0000000000000000000000000000000000000000 430a1e71314e0b97caa64260716e0cca74a0f76b RezaSbu <Ahmadireza582@gmail.com> 1765031838 +0330	clone: from https://github.com/RezaSbu/NeuraQueen.git
430a1e71314e0b97caa64260716e0cca74a0f76b 38816cfd89f9c033a4f52c4722b792a9ced985cb RezaSbu <Ahmadireza582@gmail.com> 1765033645 +0330	commit: Base project
38816cfd89f9c033a4f52c4722b792a9ced985cb 38816cfd89f9c033a4f52c4722b792a9ced985cb RezaSbu <Ahmadireza582@gmail.com> 1765033745 +0330	checkout: moving from main to V1.1
38816cfd89f9c033a4f52c4722b792a9ced985cb 38816cfd89f9c033a4f52c4722b792a9ced985cb RezaSbu <Ahmadireza582@gmail.com> 1765033765 +0330	checkout: moving from V1.1 to V1.1
38816cfd89f9c033a4f52c4722b792a9ced985cb 7ec4c17df8d876639885cee888056ce707dfd69a RezaSbu <Ahmadireza582@gmail.com> 1765033918 +0330	commit: Readme and a liitle not importatnt ui has changed
7ec4c17df8d876639885cee888056ce707dfd69a 38816cfd89f9c033a4f52c4722b792a9ced985cb RezaSbu <Ahmadireza582@gmail.com> 1765034007 +0330	checkout: moving from V1.1 to main
38816cfd89f9c033a4f52c4722b792a9ced985cb 7ec4c17df8d876639885cee888056ce707dfd69a RezaSbu <Ahmadireza582@gmail.com> 1765034017 +0330	checkout: moving from main to V1.1
7ec4c17df8d876639885cee888056ce707dfd69a 38816cfd89f9c033a4f52c4722b792a9ced985cb RezaSbu <Ahmadireza582@gmail.com> 1765034028 +0330	checkout: moving from V1.1 to main
38816cfd89f9c033a4f52c4722b792a9ced985cb cc0a61c89453efaef6617dcea8ec942d7771c22b RezaSbu <Ahmadireza582@gmail.com> 1765034034 +0330	pull: Fast-forward
cc0a61c89453efaef6617dcea8ec942d7771c22b 1605310c8478227fc1f9450c42af72bcf46eb620 RezaSbu <Ahmadireza582@gmail.com> 1765272840 +0330	commit: Guilde code has changed
1605310c8478227fc1f9450c42af72bcf46eb620 1605310c8478227fc1f9450c42af72bcf46eb620 RezaSbu <Ahmadireza582@gmail.com> 1765275960 +0330	checkout: moving from main to Login
1605310c8478227fc1f9450c42af72bcf46eb620 1605310c8478227fc1f9450c42af72bcf46eb620 RezaSbu <Ahmadireza582@gmail.com> 1765275969 +0330	checkout: moving from Login to Login
1605310c8478227fc1f9450c42af72bcf46eb620 227bd81ff1fe7e3233d433f452dd7ae6559173e7 RezaSbu <Ahmadireza582@gmail.com> 1765278303 +0330	commit: Login forn And Database Added
227bd81ff1fe7e3233d433f452dd7ae6559173e7 72f5b44330f89997d2273ae4ccdfe8c629a454c5 RezaSbu <Ahmadireza582@gmail.com> 1765282448 +0330	commit: Admin Database and Dashboard

-------------------------
.\.git\logs\refs\heads\Login:
0000000000000000000000000000000000000000 1605310c8478227fc1f9450c42af72bcf46eb620 RezaSbu <Ahmadireza582@gmail.com> 1765275960 +0330	branch: Created from HEAD
1605310c8478227fc1f9450c42af72bcf46eb620 227bd81ff1fe7e3233d433f452dd7ae6559173e7 RezaSbu <Ahmadireza582@gmail.com> 1765278303 +0330	commit: Login forn And Database Added
227bd81ff1fe7e3233d433f452dd7ae6559173e7 72f5b44330f89997d2273ae4ccdfe8c629a454c5 RezaSbu <Ahmadireza582@gmail.com> 1765282448 +0330	commit: Admin Database and Dashboard

-------------------------
.\.git\logs\refs\heads\main:
0000000000000000000000000000000000000000 430a1e71314e0b97caa64260716e0cca74a0f76b RezaSbu <Ahmadireza582@gmail.com> 1765031838 +0330	clone: from https://github.com/RezaSbu/NeuraQueen.git
430a1e71314e0b97caa64260716e0cca74a0f76b 38816cfd89f9c033a4f52c4722b792a9ced985cb RezaSbu <Ahmadireza582@gmail.com> 1765033645 +0330	commit: Base project
38816cfd89f9c033a4f52c4722b792a9ced985cb cc0a61c89453efaef6617dcea8ec942d7771c22b RezaSbu <Ahmadireza582@gmail.com> 1765034034 +0330	pull: Fast-forward
cc0a61c89453efaef6617dcea8ec942d7771c22b 1605310c8478227fc1f9450c42af72bcf46eb620 RezaSbu <Ahmadireza582@gmail.com> 1765272840 +0330	commit: Guilde code has changed

-------------------------
.\.git\logs\refs\heads\V1.1:
0000000000000000000000000000000000000000 38816cfd89f9c033a4f52c4722b792a9ced985cb RezaSbu <Ahmadireza582@gmail.com> 1765033745 +0330	branch: Created from HEAD
38816cfd89f9c033a4f52c4722b792a9ced985cb 7ec4c17df8d876639885cee888056ce707dfd69a RezaSbu <Ahmadireza582@gmail.com> 1765033918 +0330	commit: Readme and a liitle not importatnt ui has changed

-------------------------
.\.git\logs\refs\remotes\origin\HEAD:
0000000000000000000000000000000000000000 430a1e71314e0b97caa64260716e0cca74a0f76b RezaSbu <Ahmadireza582@gmail.com> 1765031838 +0330	clone: from https://github.com/RezaSbu/NeuraQueen.git

-------------------------
.\.git\logs\refs\remotes\origin\Login:
0000000000000000000000000000000000000000 227bd81ff1fe7e3233d433f452dd7ae6559173e7 RezaSbu <Ahmadireza582@gmail.com> 1765278349 +0330	update by push
227bd81ff1fe7e3233d433f452dd7ae6559173e7 72f5b44330f89997d2273ae4ccdfe8c629a454c5 RezaSbu <Ahmadireza582@gmail.com> 1765282454 +0330	update by push

-------------------------
.\.git\logs\refs\remotes\origin\main:
430a1e71314e0b97caa64260716e0cca74a0f76b 38816cfd89f9c033a4f52c4722b792a9ced985cb RezaSbu <Ahmadireza582@gmail.com> 1765033651 +0330	update by push
38816cfd89f9c033a4f52c4722b792a9ced985cb cc0a61c89453efaef6617dcea8ec942d7771c22b RezaSbu <Ahmadireza582@gmail.com> 1765034025 +0330	pull: fast-forward
cc0a61c89453efaef6617dcea8ec942d7771c22b 1605310c8478227fc1f9450c42af72bcf46eb620 RezaSbu <Ahmadireza582@gmail.com> 1765272845 +0330	update by push

-------------------------
.\.git\logs\refs\remotes\origin\V1.1:
0000000000000000000000000000000000000000 7ec4c17df8d876639885cee888056ce707dfd69a RezaSbu <Ahmadireza582@gmail.com> 1765033935 +0330	update by push

-------------------------
.\.git\refs\heads\Login:
72f5b44330f89997d2273ae4ccdfe8c629a454c5

-------------------------
.\.git\refs\heads\main:
1605310c8478227fc1f9450c42af72bcf46eb620

-------------------------
.\.git\refs\heads\V1.1:
7ec4c17df8d876639885cee888056ce707dfd69a

-------------------------
.\.git\refs\remotes\origin\HEAD:
ref: refs/remotes/origin/main

-------------------------
.\.git\refs\remotes\origin\Login:
72f5b44330f89997d2273ae4ccdfe8c629a454c5

-------------------------
.\.git\refs\remotes\origin\main:
1605310c8478227fc1f9450c42af72bcf46eb620

-------------------------
.\.git\refs\remotes\origin\V1.1:
7ec4c17df8d876639885cee888056ce707dfd69a

-------------------------
.\components\AdminDashboard.tsx:
import React, { useState, useEffect } from 'react';
import { adminService } from '../services/adminService';
import ReactMarkdown from 'react-markdown';
import { 
  Users, MessageSquare, Database, Download, LogOut, 
  BarChart3, Activity, Search, Calendar, ShieldCheck, 
  Trash2, Sparkles, TrendingUp, AlertCircle, RefreshCw
} from 'lucide-react';

interface Props {
  onLogout: () => void;
}

const AdminDashboard: React.FC<Props> = ({ onLogout }) => {
  const [activeTab, setActiveTab] = useState<'overview' | 'users' | 'sessions' | 'ai_insight'>('overview');
  const [stats, setStats] = useState({ usersCount: 0, sessionsCount: 0, totalMessages: 0, messagesToday: 0 });
  const [usersData, setUsersData] = useState<any[]>([]);
  const [sessionsData, setSessionsData] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  
  // New States
  const [searchTerm, setSearchTerm] = useState('');
  const [aiReport, setAiReport] = useState('');
  const [loadingReport, setLoadingReport] = useState(false);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setLoading(true);
    const s = await adminService.getStats();
    setStats(s);
    
    const u = await adminService.getUsers();
    setUsersData(u);
    
    const c = await adminService.getSessions();
    setSessionsData(c);
    setLoading(false);
  };

  const handleDeleteUser = async (userId: string) => {
      if(!window.confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ùˆ ØªÙ…Ø§Ù… Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ùˆ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")) return;
      
      const res = await adminService.deleteUser(userId);
      if(res.success) {
          setUsersData(prev => prev.filter(u => u.user_id !== userId));
          // Refresh stats slightly
          setStats(prev => ({...prev, usersCount: prev.usersCount - 1}));
      } else {
          alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±");
      }
  };

  const handleGenerateReport = async () => {
      setLoadingReport(true);
      const report = await adminService.generateBusinessReport();
      setAiReport(report);
      setLoadingReport(false);
  };

  const downloadJSON = (data: any[], filename: string) => {
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Filter Users
  const filteredUsers = usersData.filter(user => 
    (user.name?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
    (user.username?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
    (user.number || '').includes(searchTerm)
  );

  if (loading) return (
    <div className="min-h-screen bg-[#09090b] text-white flex flex-col items-center justify-center gap-4">
        <div className="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
        <p className="animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ...</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#050505] text-white font-sans overflow-hidden flex" dir="rtl">
      
      {/* Sidebar - Glassmorphism */}
      <aside className="w-72 bg-[#121212]/50 backdrop-blur-xl border-l border-white/5 flex flex-col h-screen fixed right-0 top-0 z-50">
        <div className="p-8 border-b border-white/5">
            <div className="flex items-center gap-3 mb-1">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-tr from-red-600 to-orange-600 flex items-center justify-center shadow-lg shadow-red-500/20">
                    <ShieldCheck className="text-white" size={20} />
                </div>
                <div>
                    <h1 className="font-bold text-lg tracking-wide">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h1>
                    <span className="text-[10px] text-gray-500 uppercase tracking-widest">StarCycle Admin</span>
                </div>
            </div>
        </div>

        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
            <NavButton active={activeTab === 'overview'} onClick={() => setActiveTab('overview')} icon={BarChart3} label="Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ùˆ Ø¢Ù…Ø§Ø±" />
            <NavButton active={activeTab === 'ai_insight'} onClick={() => setActiveTab('ai_insight')} icon={Sparkles} label="Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Ø¬Ø¯ÛŒØ¯)" isNew />
            <NavButton active={activeTab === 'users'} onClick={() => setActiveTab('users')} icon={Users} label="Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†" badge={usersData.length} />
            <NavButton active={activeTab === 'sessions'} onClick={() => setActiveTab('sessions')} icon={MessageSquare} label="ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øªâ€ŒÙ‡Ø§" />
        </nav>

        <div className="p-4 border-t border-white/5 bg-gradient-to-t from-red-900/10 to-transparent">
            <button 
                onClick={onLogout}
                className="w-full flex items-center gap-3 p-3 rounded-xl text-red-400 hover:bg-red-500/10 hover:text-red-300 transition-all duration-300 group"
            >
                <LogOut size={20} className="group-hover:-translate-x-1 transition-transform" />
                <span className="font-medium">Ø®Ø±ÙˆØ¬ Ø§Ù…Ù†</span>
            </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 mr-72 p-8 h-screen overflow-y-auto scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent">
        
        {/* OVERVIEW TAB */}
        {activeTab === 'overview' && (
            <div className="space-y-8 animate-fadeIn max-w-6xl mx-auto">
                <header className="flex justify-between items-end">
                    <div>
                        <h2 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-l from-white to-gray-500 mb-2">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆØ¶Ø¹ÛŒØª</h2>
                        <p className="text-gray-400">Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±Ø¨Ø§Øª Ùˆ ØªØ¹Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
                    </div>
                    <button onClick={loadData} className="p-2 bg-white/5 hover:bg-white/10 rounded-full transition-colors"><RefreshCw size={20} /></button>
                </header>

                {/* Stats Grid */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <StatCard title="Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†" value={stats.usersCount} icon={Users} color="blue" />
                    <StatCard title="Ù†Ø´Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„" value={stats.sessionsCount} icon={MessageSquare} color="green" />
                    <StatCard title="Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§" value={stats.totalMessages} icon={Database} color="yellow" />
                    <StatCard title="Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²" value={stats.messagesToday} icon={Calendar} color="purple" />
                </div>

                {/* Charts Area */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* User Growth Chart (Simulated) */}
                    <div className="lg:col-span-2 bg-[#121212] border border-white/5 rounded-3xl p-6 relative overflow-hidden">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg flex items-center gap-2">
                                <TrendingUp className="text-primary" size={20} />
                                Ø±Ø´Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                            </h3>
                            <span className="text-xs bg-white/5 px-2 py-1 rounded-md text-gray-400">Ù‡ÙØªÚ¯ÛŒ</span>
                        </div>
                        <div className="h-48 flex items-end gap-4 justify-between px-2">
                            {/* Dummy Chart Bars */}
                            {[30, 45, 35, 60, 55, 75, 90].map((h, i) => (
                                <div key={i} className="flex-1 flex flex-col justify-end group">
                                    <div 
                                        style={{ height: `${h}%` }} 
                                        className="w-full bg-gradient-to-t from-primary/20 to-primary/80 rounded-t-lg transition-all duration-500 group-hover:from-primary/40 group-hover:to-primary"
                                    ></div>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-between mt-2 text-xs text-gray-500 px-1">
                            <span>Ø´Ù†Ø¨Ù‡</span><span>Ø¬Ù…Ø¹Ù‡</span>
                        </div>
                    </div>

                    {/* Quick Actions */}
                    <div className="bg-[#121212] border border-white/5 rounded-3xl p-6 flex flex-col justify-center gap-4">
                        <h3 className="font-bold text-gray-300 mb-2">Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹</h3>
                        <button onClick={() => downloadJSON(usersData, 'users_db')} className="w-full flex items-center justify-between bg-white/5 hover:bg-white/10 p-4 rounded-xl transition-all border border-white/5 hover:border-white/20">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-500/20 p-2 rounded-lg"><Download className="text-blue-500" size={18} /></div>
                                <span className="text-sm">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</span>
                            </div>
                        </button>
                        <button onClick={() => downloadJSON(sessionsData, 'chat_sessions_db')} className="w-full flex items-center justify-between bg-white/5 hover:bg-white/10 p-4 rounded-xl transition-all border border-white/5 hover:border-white/20">
                            <div className="flex items-center gap-3">
                                <div className="bg-green-500/20 p-2 rounded-lg"><Download className="text-green-500" size={18} /></div>
                                <span className="text-sm">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú†Øªâ€ŒÙ‡Ø§</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        )}

        {/* AI INSIGHT TAB */}
        {activeTab === 'ai_insight' && (
             <div className="space-y-6 animate-fadeIn max-w-4xl mx-auto">
                <div className="bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border border-indigo-500/30 rounded-3xl p-8 relative overflow-hidden">
                    <Sparkles className="absolute top-4 left-4 text-indigo-400 opacity-50" size={100} />
                    <div className="relative z-10">
                        <h2 className="text-3xl font-bold mb-4">Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø¨Ø§Ø²Ø§Ø±</h2>
                        <p className="text-indigo-200 mb-6 max-w-xl leading-relaxed">
                            Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ ÛµÛ° Ù¾ÛŒØ§Ù… Ø¢Ø®Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŒ ÛŒÚ© Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ø§Ø² Ù†ÛŒØ§Ø²Ù‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±ØŒ Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ù¾Ø±ØªÙ‚Ø§Ø¶Ø§ Ùˆ Ø±ÙØªØ§Ø± Ù…Ø´ØªØ±ÛŒØ§Ù† ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
                        </p>
                        <button 
                            onClick={handleGenerateReport}
                            disabled={loadingReport}
                            className="bg-white text-indigo-900 hover:bg-indigo-50 font-bold px-8 py-4 rounded-2xl shadow-xl shadow-indigo-900/50 transition-all flex items-center gap-3 disabled:opacity-70 disabled:cursor-not-allowed"
                        >
                            {loadingReport ? (
                                <><div className="w-5 h-5 border-2 border-indigo-900 border-t-transparent rounded-full animate-spin"/> Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...</>
                            ) : (
                                <><Sparkles size={20} /> ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙˆØ´Ù…Ù†Ø¯</>
                            )}
                        </button>
                    </div>
                </div>

                {aiReport && (
                    <div className="bg-[#121212] border border-white/10 rounded-3xl p-8 animate-slideUp">
                        <h3 className="text-xl font-bold mb-6 text-primary border-b border-white/5 pb-4">Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„:</h3>
                        <div className="markdown-content text-gray-300 leading-8">
                             <ReactMarkdown components={{strong: ({node, ...props}) => <span className="text-white font-bold bg-white/10 px-1 rounded" {...props} />}}>{aiReport}</ReactMarkdown>
                        </div>
                    </div>
                )}
             </div>
        )}

        {/* USERS TAB */}
        {activeTab === 'users' && (
            <div className="space-y-6 animate-fadeIn max-w-6xl mx-auto">
                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                    <h2 className="text-2xl font-bold">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
                    <div className="relative w-full md:w-96">
                        <Search className="absolute right-3 top-3 text-gray-500" size={20} />
                        <input 
                            type="text" 
                            placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Ù†Ø§Ù…ØŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡..." 
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full bg-[#121212] border border-white/10 focus:border-primary/50 rounded-xl py-2.5 pr-10 pl-4 text-white outline-none"
                        />
                    </div>
                </div>
                
                {usersData.length === 0 ? (
                     <div className="flex flex-col items-center justify-center py-20 bg-[#121212] rounded-3xl border border-white/5 border-dashed">
                        <AlertCircle className="text-gray-600 mb-4" size={48} />
                        <p className="text-gray-500">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
                     </div>
                ) : (
                    <div className="bg-[#121212] rounded-3xl border border-white/5 overflow-hidden shadow-2xl">
                        <div className="overflow-x-auto">
                            <table className="w-full text-right">
                                <thead className="bg-white/5 text-gray-400 text-xs uppercase tracking-wider">
                                    <tr>
                                        <th className="p-5">Ú©Ø§Ø±Ø¨Ø±</th>
                                        <th className="p-5">Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³</th>
                                        <th className="p-5">ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª</th>
                                        <th className="p-5 text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-white/5">
                                    {filteredUsers.map((user) => (
                                        <tr key={user.user_id} className="hover:bg-white/[0.02] transition-colors group">
                                            <td className="p-5">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center text-sm font-bold">
                                                        {(user.name?.[0] || 'U').toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div className="font-bold text-white">{user.name} {user.last_name}</div>
                                                        <div className="text-xs text-gray-500 font-mono">@{user.username}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="p-5 font-mono text-gray-400">{user.number}</td>
                                            <td className="p-5 text-gray-400 text-sm">
                                                {new Date(user.signup_date || user.signup_Date).toLocaleDateString('fa-IR')}
                                            </td>
                                            <td className="p-5 text-center">
                                                <button 
                                                    onClick={() => handleDeleteUser(user.user_id)}
                                                    className="p-2 text-gray-600 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-all" 
                                                    title="Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±"
                                                >
                                                    <Trash2 size={18} />
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        )}

        {/* SESSIONS TAB */}
        {activeTab === 'sessions' && (
            <div className="space-y-6 animate-fadeIn max-w-6xl mx-auto">
                 <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øªâ€ŒÙ‡Ø§</h2>
                </div>

                <div className="grid gap-4">
                    {sessionsData.slice(0, 50).map((session, idx) => (
                        <div key={idx} className="bg-[#121212] p-5 rounded-2xl border border-white/5 hover:border-primary/20 transition-all group">
                            <div className="flex justify-between items-start mb-3">
                                <div className="flex items-center gap-3">
                                    <div className="bg-white/5 p-2 rounded-lg text-primary"><MessageSquare size={18} /></div>
                                    <div>
                                        <h4 className="font-bold text-gray-200">{session.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</h4>
                                        <span className="text-[10px] text-gray-500 font-mono uppercase tracking-wider">ID: {session.id}</span>
                                    </div>
                                </div>
                                <span className="text-xs text-gray-500 bg-black/40 px-2 py-1 rounded-md">{new Date(session.last_modified).toLocaleString('fa-IR')}</span>
                            </div>
                            
                            <div className="bg-[#09090b] p-4 rounded-xl max-h-40 overflow-y-auto text-sm space-y-3 custom-scrollbar">
                                {session.messages?.map((m: any, i: number) => (
                                    <div key={i} className={`flex gap-3 ${m.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                        <span className={`text-[10px] font-bold uppercase px-1 py-0.5 rounded h-fit ${m.role === 'user' ? 'bg-gray-800 text-gray-400' : 'bg-primary/20 text-primary'}`}>
                                            {m.role === 'user' ? 'User' : 'Bot'}
                                        </span>
                                        <p className={`text-gray-400 leading-relaxed ${m.role === 'user' ? 'text-right' : 'text-left'} w-full`}>{m.text}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}
      </main>
    </div>
  );
};

// Helper Components
const StatCard = ({ title, value, icon: Icon, color }: any) => {
    const colorStyles: any = {
        blue: "from-blue-500/20 to-blue-600/5 text-blue-500",
        green: "from-green-500/20 to-green-600/5 text-green-500",
        yellow: "from-yellow-500/20 to-yellow-600/5 text-yellow-500",
        purple: "from-purple-500/20 to-purple-600/5 text-purple-500",
    };

    return (
        <div className="bg-[#121212] border border-white/5 p-6 rounded-3xl relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
            <div className={`absolute top-0 right-0 w-32 h-32 bg-gradient-to-br ${colorStyles[color]} blur-2xl rounded-full -mr-10 -mt-10 pointer-events-none`}></div>
            <div className="relative z-10 flex justify-between items-start">
                <div>
                    <p className="text-gray-400 text-sm font-medium mb-1">{title}</p>
                    <h3 className="text-4xl font-black text-white">{value}</h3>
                </div>
                <div className={`p-3 rounded-xl bg-white/5 ${colorStyles[color].split(' ')[2]}`}>
                    <Icon size={24} />
                </div>
            </div>
        </div>
    );
};

const NavButton = ({ active, onClick, icon: Icon, label, badge, isNew }: any) => (
    <button 
        onClick={onClick}
        className={`
            w-full flex items-center justify-between p-3.5 rounded-xl transition-all duration-200 group
            ${active 
                ? 'bg-gradient-to-r from-primary/20 to-transparent text-primary border-r-2 border-primary' 
                : 'text-gray-400 hover:bg-white/5 hover:text-gray-200 border-r-2 border-transparent'}
        `}
    >
        <div className="flex items-center gap-3">
            <Icon size={20} className={active ? 'animate-pulse' : ''} />
            <span className="font-medium text-sm">{label}</span>
        </div>
        {badge !== undefined && (
            <span className="bg-white/10 text-xs px-2 py-0.5 rounded-md">{badge}</span>
        )}
        {isNew && (
            <span className="bg-indigo-500 text-[10px] font-bold text-white px-1.5 py-0.5 rounded animate-pulse">Ø¬Ø¯ÛŒØ¯</span>
        )}
    </button>
);

export default AdminDashboard;
-------------------------
.\components\AuthScreen.tsx:
import React, { useState } from 'react';
import { User as UserIcon, Lock, Phone, UserPlus, LogIn, ChevronRight, ShieldCheck } from 'lucide-react';
import { authService } from '../services/authService';
import { adminService } from '../services/adminService';
import { User } from '../types';

interface Props {
  onAuthSuccess: (user: User) => void;
  onAdminLogin: () => void;
}

const AuthScreen: React.FC<Props> = ({ onAuthSuccess, onAdminLogin }) => {
  const [isLogin, setIsLogin] = useState(true);
  const [isAdminMode, setIsAdminMode] = useState(false); // New State for Admin View
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  // Login State
  const [loginId, setLoginId] = useState('');
  const [loginPass, setLoginPass] = useState('');

  // Signup State
  const [signupData, setSignupData] = useState({
    name: '',
    last_name: '',
    username: '',
    number: '',
    pass: ''
  });

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);
    
    // ADMIN LOGIC
    if (isAdminMode) {
        const res = await adminService.login(loginId, loginPass);
        if (res.success) {
            onAdminLogin();
        } else {
            setError('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø¯Ù…ÛŒÙ† Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.');
        }
        setIsLoading(false);
        return;
    }

    // USER LOGIC
    const result = await authService.login(loginId, loginPass);
    if (result.success && result.user) {
      onAuthSuccess(result.user);
    } else {
      setError(result.error || 'Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯');
    }
    setIsLoading(false);
  };

  const handleSignup = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    
    if (!signupData.number || !signupData.username || !signupData.pass) {
        setError("Ù„Ø·ÙØ§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯");
        return;
    }

    setIsLoading(true);
    const result = await authService.signup(signupData);
    if (result.success && result.user) {
      onAuthSuccess(result.user);
    } else {
      setError(result.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…');
    }
    setIsLoading(false);
  };

  return (
    <div className="min-h-screen bg-black flex flex-col items-center justify-center p-4 relative overflow-hidden">
      {/* Background Elements */}
      <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-primary/20 rounded-full blur-[120px] pointer-events-none"></div>
      <div className="absolute bottom-[-10%] right-[-10%] w-[30%] h-[30%] bg-blue-500/10 rounded-full blur-[100px] pointer-events-none"></div>

      <div className="w-full max-w-md bg-[#121212] border border-white/10 rounded-3xl shadow-2xl overflow-hidden relative z-10 transition-all duration-500">
        
        {/* Header Toggle (Hidden in Admin Mode) */}
        {!isAdminMode && (
            <div className="flex p-2 bg-[#1E1E1E]">
            <button 
                onClick={() => { setIsLogin(true); setError(''); }}
                className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all duration-300 ${isLogin ? 'bg-primary text-black shadow-lg shadow-primary/20' : 'text-gray-500 hover:text-gray-300'}`}
            >
                ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨
            </button>
            <button 
                onClick={() => { setIsLogin(false); setError(''); }}
                className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all duration-300 ${!isLogin ? 'bg-white text-black shadow-lg' : 'text-gray-500 hover:text-gray-300'}`}
            >
                Ø«Ø¨Øª Ù†Ø§Ù… Ø±Ø§ÛŒÚ¯Ø§Ù†
            </button>
            </div>
        )}

        {/* Admin Header */}
        {isAdminMode && (
            <div className="p-4 bg-red-900/20 border-b border-red-500/30 flex items-center gap-3">
                <button onClick={() => { setIsAdminMode(false); setError(''); setLoginId(''); setLoginPass(''); }} className="text-gray-400 hover:text-white">
                    <ChevronRight className="rotate-180" />
                </button>
                <h3 className="text-red-500 font-bold flex items-center gap-2">
                    <ShieldCheck size={20} />
                    ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
                </h3>
            </div>
        )}

        <div className="p-8">
           <div className="text-center mb-8">
             <h2 className="text-2xl font-black text-white mb-2">
               {isAdminMode ? 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ Ù…Ø¯ÛŒØ±' : (isLogin ? 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! ğŸ‘‹' : 'Ø³Ø§Ø®Øª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ ğŸš€')}
             </h2>
             <p className="text-gray-400 text-sm">
               {isAdminMode ? 'Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯' : (isLogin ? 'Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯' : 'Ø¨Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ø§Ø³ØªØ§Ø± Ø³ÛŒÚ©Ù„Øª Ø¨Ù¾ÛŒÙˆÙ†Ø¯ÛŒØ¯')}
             </p>
           </div>

           {error && (
             <div className="mb-6 p-3 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-xs text-center animate-fadeIn">
               {error}
             </div>
           )}

           {(isLogin || isAdminMode) ? (
             // Login / Admin Form
             <form onSubmit={handleLogin} className="space-y-4">
                <div className="space-y-1">
                    <label className="text-xs text-gray-400 mr-1">{isAdminMode ? 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ø¯Ù…ÛŒÙ†' : 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„'}</label>
                    <div className="relative">
                        <UserIcon size={18} className="absolute right-3 top-3.5 text-gray-500" />
                        <input 
                          type="text" 
                          value={loginId}
                          onChange={(e) => setLoginId(e.target.value)}
                          className={`w-full bg-[#1E1E1E] border ${isAdminMode ? 'focus:border-red-500/50' : 'focus:border-primary/50'} border-white/10 text-white rounded-xl py-3 pr-10 pl-4 outline-none transition-all placeholder-gray-600`}
                          placeholder={isAdminMode ? "Admin" : "Ù…Ø«Ù„Ø§: 0912..."}
                        />
                    </div>
                </div>

                <div className="space-y-1">
                    <label className="text-xs text-gray-400 mr-1">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <div className="relative">
                        <Lock size={18} className="absolute right-3 top-3.5 text-gray-500" />
                        <input 
                          type="password" 
                          value={loginPass}
                          onChange={(e) => setLoginPass(e.target.value)}
                          className={`w-full bg-[#1E1E1E] border ${isAdminMode ? 'focus:border-red-500/50' : 'focus:border-primary/50'} border-white/10 text-white rounded-xl py-3 pr-10 pl-4 outline-none transition-all placeholder-gray-600`}
                          placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        />
                    </div>
                </div>

                <button 
                  type="submit" 
                  disabled={isLoading}
                  className={`w-full ${isAdminMode ? 'bg-red-600 hover:bg-red-500 shadow-red-500/20' : 'bg-primary hover:bg-green-400 shadow-primary/20'} text-white font-bold py-3.5 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2 mt-4`}
                >
                  {isLoading ? 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...' : (
                    <>
                      <span>{isAdminMode ? 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„' : 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…'}</span>
                      <LogIn size={18} />
                    </>
                  )}
                </button>
             </form>
           ) : (
             // Signup Form
             <form onSubmit={handleSignup} className="space-y-3">
                <div className="grid grid-cols-2 gap-3">
                   <input 
                     type="text" 
                     value={signupData.name}
                     onChange={(e) => setSignupData({...signupData, name: e.target.value})}
                     className="bg-[#1E1E1E] border border-white/10 focus:border-white/30 text-white rounded-xl py-3 px-4 outline-none transition-all placeholder-gray-600 text-sm"
                     placeholder="Ù†Ø§Ù…"
                   />
                   <input 
                     type="text" 
                     value={signupData.last_name}
                     onChange={(e) => setSignupData({...signupData, last_name: e.target.value})}
                     className="bg-[#1E1E1E] border border-white/10 focus:border-white/30 text-white rounded-xl py-3 px-4 outline-none transition-all placeholder-gray-600 text-sm"
                     placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ"
                   />
                </div>

                <div className="relative">
                    <UserIcon size={18} className="absolute right-3 top-3.5 text-gray-500" />
                    <input 
                      type="text"
                      value={signupData.username}
                      onChange={(e) => setSignupData({...signupData, username: e.target.value})} 
                      className="w-full bg-[#1E1E1E] border border-white/10 focus:border-primary/50 text-white rounded-xl py-3 pr-10 pl-4 outline-none transition-all placeholder-gray-600 text-sm"
                      placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)"
                      dir="ltr"
                    />
                </div>

                <div className="relative">
                    <Phone size={18} className="absolute right-3 top-3.5 text-gray-500" />
                    <input 
                      type="tel"
                      value={signupData.number}
                      onChange={(e) => setSignupData({...signupData, number: e.target.value})} 
                      className="w-full bg-[#1E1E1E] border border-white/10 focus:border-primary/50 text-white rounded-xl py-3 pr-10 pl-4 outline-none transition-all placeholder-gray-600 text-sm"
                      placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„"
                      dir="ltr"
                    />
                </div>

                <div className="relative">
                    <Lock size={18} className="absolute right-3 top-3.5 text-gray-500" />
                    <input 
                      type="password"
                      value={signupData.pass}
                      onChange={(e) => setSignupData({...signupData, pass: e.target.value})} 
                      className="w-full bg-[#1E1E1E] border border-white/10 focus:border-primary/50 text-white rounded-xl py-3 pr-10 pl-4 outline-none transition-all placeholder-gray-600 text-sm"
                      placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±"
                      dir="ltr"
                    />
                </div>

                <button 
                  type="submit"
                  disabled={isLoading} 
                  className="w-full bg-white hover:bg-gray-200 text-black font-bold py-3.5 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2 mt-2"
                >
                  {isLoading ? 'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...' : (
                    <>
                      <span>Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯</span>
                      <UserPlus size={18} />
                    </>
                  )}
                </button>
             </form>
           )}
        </div>
      </div>
      
      {/* Admin Login Trigger - Positioned far below */}
      {!isAdminMode && (
          <div className="absolute bottom-6 right-6 opacity-30 hover:opacity-100 transition-opacity">
            <button 
                onClick={() => { setIsAdminMode(true); setError(''); setLoginId(''); setLoginPass(''); }}
                className="text-xs text-white flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/10"
            >
                <ShieldCheck size={14} />
                ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†
            </button>
          </div>
      )}
    </div>
  );
};

export default AuthScreen;
-------------------------
.\components\ChatMessage.tsx:
import React, { useState, useEffect, memo } from 'react';
import { ChatMessage as ChatMessageType, ProductMatch } from '../types';
import ProductCard from './ProductCard';
import Typewriter from './Typewriter';
import ReactMarkdown from 'react-markdown';
import { User, Cpu, BrainCircuit } from 'lucide-react';

interface Props {
  message: ChatMessageType;
  isLastMessage: boolean;
  onCompare: (product: ProductMatch) => void;
  compareList: ProductMatch[];
}

const ChatMessage: React.FC<Props> = ({ message, isLastMessage, onCompare, compareList }) => {
  const isUser = message.role === 'user';
  const hasProducts = message.products && message.products.length > 0;
  
  // Logic to determine if we should animate:
  // 1. It must be the last message.
  // 2. It must be recent (created in the last 10 seconds). 
  // This prevents re-typing when loading history or switching sessions.
  const isRecent = message.timestamp ? (Date.now() - message.timestamp < 10000) : true;
  const shouldAnimate = !isUser && isLastMessage && isRecent;

  const [isTyped, setIsTyped] = useState(!shouldAnimate);

  useEffect(() => {
     // If it stops being the last message, force it to 'typed' state immediately.
     if (!isLastMessage) {
         setIsTyped(true);
     }
  }, [isLastMessage]);

  return (
    <div className={`flex w-full mb-8 ${isUser ? 'justify-end' : 'justify-start'} animate-fadeIn group`}>
      <div className={`flex max-w-[95%] md:max-w-[85%] gap-4 ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>
        
        {/* Avatar */}
        <div className={`
          w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 shadow-2xl border border-white/10
          ${isUser 
            ? 'bg-gradient-to-br from-gray-700 to-gray-800 text-gray-300' 
            : 'bg-gradient-to-br from-[#00D084] to-[#00A060] text-black shadow-primary/20'}
        `}>
          {isUser ? <User size={20} /> : <BrainCircuit size={22} />}
        </div>

        {/* Content Container */}
        <div className="flex flex-col gap-3 w-full min-w-0">
           
           {/* Header Name (Bot only) */}
           {!isUser && (
             <span className="text-xs font-bold text-gray-500 mb-[-5px] mr-1">Mobinext AI</span>
           )}

           {/* Text Bubble */}
           {message.text && !message.isThinking && (
             <div className={`
              px-6 py-5 rounded-3xl text-[15px] leading-8 shadow-sm backdrop-blur-sm
              ${isUser 
                ? 'bg-[#2A2A2A] text-white rounded-tr-md border border-white/5' 
                : 'bg-[#1E1E1E]/80 text-gray-100 rounded-tl-md border border-white/5'}
            `}>
              {!isTyped ? (
                  <Typewriter 
                      text={message.text} 
                      speed={15} 
                      onComplete={() => setIsTyped(true)} 
                  />
              ) : (
                  <div className="markdown-content">
                    <ReactMarkdown
                        components={{
                        strong: ({node, ...props}) => <span className="font-bold text-primary" {...props} />,
                        ul: ({node, ...props}) => <ul className="list-disc list-inside my-2 space-y-1 text-gray-300" {...props} />,
                        p: ({node, ...props}) => <p className="mb-2 last:mb-0" {...props} />,
                        a: ({node, ...props}) => <a className="text-blue-400 hover:underline" target="_blank" {...props} />
                        }}
                    >
                        {message.text}
                    </ReactMarkdown>
                  </div>
              )}
            </div>
           )}

           {/* Thinking State */}
           {message.isThinking && (
             <div className="flex items-center gap-3 px-5 py-4 bg-[#1E1E1E]/50 border border-white/5 rounded-3xl rounded-tl-md w-fit">
               <div className="relative w-8 h-8 flex items-center justify-center">
                  <div className="absolute inset-0 border-2 border-primary/30 rounded-full animate-ping"></div>
                  <div className="absolute inset-0 border-2 border-primary rounded-full animate-spin border-t-transparent"></div>
                  <Cpu size={14} className="text-primary" />
               </div>
               <span className="text-sm font-medium text-gray-400 animate-pulse">Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...</span>
             </div>
           )}

            {/* Product Grid - Show if typed OR if it's an old message */}
            {hasProducts && (isTyped || !isLastMessage) && (
             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-2 animate-slideUp">
               {message.products?.map((product, idx) => (
                 <ProductCard 
                   key={`${product.id}-${idx}`} 
                   product={product} 
                   index={idx}
                   onCompare={onCompare}
                   isSelectedForCompare={compareList.some(p => p.title === product.title)}
                 />
               ))}
             </div>
           )}
        </div>
      </div>
    </div>
  );
};

export default memo(ChatMessage);
-------------------------
.\components\ComparisonModal.tsx:
import React from 'react';
import { ProductMatch } from '../types';
import { X, ExternalLink } from 'lucide-react';

interface Props {
  products: ProductMatch[];
  onClose: () => void;
}

const ComparisonModal: React.FC<Props> = ({ products, onClose }) => {
  const formatPrice = (p: number | string) => new Intl.NumberFormat('fa-IR').format(Number(p));

  // Collect all unique features found in these products to build rows
  // Since normalized features are strings, we might just list them.
  // For a better table, we would assume Key: Value structure in strings.
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fadeIn">
      <div className="bg-[#1a1a1a] w-full max-w-5xl rounded-2xl border border-white/10 shadow-2xl flex flex-col max-h-[90vh]">
        
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-white/10">
          <h2 className="text-xl font-bold text-white">Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª ({products.length})</h2>
          <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors">
            <X size={24} />
          </button>
        </div>

        {/* Table Container */}
        <div className="overflow-auto p-4 flex-1 scrollbar-thin">
          <table className="w-full text-right border-collapse">
            <thead>
              <tr>
                <th className="p-4 text-gray-500 font-normal min-w-[120px]">Ù…Ø´Ø®ØµØ§Øª</th>
                {products.map((p, i) => (
                  <th key={i} className="p-4 min-w-[220px] bg-white/5 rounded-t-xl mx-2 border-b border-white/10 align-top">
                    <div className="flex flex-col gap-3">
                      {p.image && (
                        <div className="h-32 w-full rounded-lg overflow-hidden bg-black">
                           <img src={p.image} alt={p.title} className="w-full h-full object-contain" />
                        </div>
                      )}
                      <span className="text-sm font-bold text-white line-clamp-2 h-10">{p.title}</span>
                      <div className="text-primary font-mono text-lg">{formatPrice(p.price)} <span className="text-xs">ØªÙˆÙ…Ø§Ù†</span></div>
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              
              {/* Category */}
              <tr>
                <td className="p-4 text-gray-400">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</td>
                {products.map((p, i) => (
                  <td key={i} className="p-4 text-gray-200">{p.category || '-'}</td>
                ))}
              </tr>

              {/* Features List */}
              <tr>
                 <td className="p-4 text-gray-400 align-top">ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§</td>
                 {products.map((p, i) => (
                   <td key={i} className="p-4 align-top">
                     <ul className="list-disc list-inside text-sm text-gray-300 space-y-1">
                       {p.features?.map((f, idx) => (
                         <li key={idx}>{f}</li>
                       ))}
                     </ul>
                   </td>
                 ))}
              </tr>

              {/* Action */}
              <tr>
                <td className="p-4"></td>
                {products.map((p, i) => (
                  <td key={i} className="p-4">
                    <a 
                      href={p.link} 
                      target="_blank" 
                      className="flex items-center justify-center gap-2 w-full bg-primary hover:bg-green-400 text-black font-bold py-2 rounded-lg transition-colors"
                    >
                      Ø®Ø±ÛŒØ¯ <ExternalLink size={16} />
                    </a>
                  </td>
                ))}
              </tr>

            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

export default ComparisonModal;
-------------------------
.\components\ProductCard.tsx:
import React from 'react';
import { ProductMatch } from '../types';
import { ShoppingCart, ExternalLink, Sparkles, Scale } from 'lucide-react';

interface Props {
  product: ProductMatch;
  index: number;
  onCompare: (product: ProductMatch) => void;
  isSelectedForCompare: boolean;
}

const ProductCard: React.FC<Props> = ({ product, index, onCompare, isSelectedForCompare }) => {
  const formatPrice = (p: number | string) => {
    return new Intl.NumberFormat('fa-IR').format(Number(p));
  };

  const displayFeatures = product.features?.slice(0, 3) || [];

  return (
    <div className={`
      group relative flex flex-col w-72 h-[420px] rounded-3xl overflow-hidden 
      transition-all duration-300 hover:-translate-y-2
      ${product.isCloseMatch 
        ? 'bg-gradient-to-b from-[#2a2a2a] to-[#1a1a00] border border-yellow-500/20' 
        : 'bg-[#1E1E1E] border border-white/5 hover:border-primary/40'}
       shadow-lg hover:shadow-2xl hover:shadow-primary/5
    `}>
      
      {/* Number Badge */}
      <div className="absolute top-3 left-3 z-20 w-8 h-8 rounded-full bg-black/60 backdrop-blur-md border border-white/10 flex items-center justify-center text-white font-mono font-bold shadow-lg">
        {index + 1}
      </div>

      {/* Compare Checkbox */}
      <div className="absolute top-3 right-3 z-20">
        <button 
          onClick={(e) => { e.preventDefault(); onCompare(product); }}
          className={`
            p-2 rounded-full backdrop-blur-md border transition-all duration-200
            ${isSelectedForCompare 
              ? 'bg-primary text-black border-primary' 
              : 'bg-black/40 text-gray-400 border-white/10 hover:bg-white/10 hover:text-white'}
          `}
          title="Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù…Ù‚Ø§ÛŒØ³Ù‡"
        >
          <Scale size={16} />
        </button>
      </div>

      {/* Close Match Label */}
      {product.isCloseMatch && (
        <div className="absolute top-14 right-3 z-20 bg-yellow-500/90 text-black text-[10px] font-bold px-2 py-1 rounded-md flex items-center gap-1 shadow-lg backdrop-blur-sm">
          <Sparkles size={10} />
          <span>Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ø´Ø§Ø¨Ù‡</span>
        </div>
      )}

      {/* Image Section */}
      <div className="h-48 bg-gray-900 relative overflow-hidden shrink-0 group">
        {product.image ? (
            <img 
              src={product.image} 
              alt={product.title} 
              className="w-full h-full object-cover opacity-90 group-hover:opacity-100 group-hover:scale-105 transition-all duration-500" 
            />
        ) : (
            <div className="w-full h-full flex items-center justify-center bg-gray-800 text-gray-600">
               <span className="text-xs">ØªØµÙˆÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</span>
            </div>
        )}
        <div className="absolute inset-0 bg-gradient-to-t from-[#1E1E1E] via-transparent to-transparent opacity-100" />
      </div>

      {/* Content Section */}
      <div className="p-5 flex flex-col flex-1 relative -mt-8">
        
        {/* Category */}
        <div className="mb-2">
            <span className="inline-block bg-white/5 border border-white/5 backdrop-blur-sm text-gray-400 text-[10px] px-2 py-1 rounded-md">
                {product.category || 'Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ'}
            </span>
        </div>

        {/* Title */}
        <h3 className="text-sm font-bold text-gray-100 mb-3 line-clamp-2 leading-relaxed h-10 group-hover:text-primary transition-colors">
          {product.title}
        </h3>

        {/* Features */}
        <div className="flex flex-col gap-1 mb-auto">
          {displayFeatures.map((f, i) => (
            <div key={i} className="flex items-center gap-1.5 text-[11px] text-gray-400">
               <span className="w-1 h-1 rounded-full bg-primary/50"></span>
               <span className="truncate">{f}</span>
            </div>
          ))}
        </div>

        {/* Price & Action */}
        <div className="mt-4 pt-3 border-t border-white/5">
          <div className="flex flex-col mb-3">
             <span className="text-[10px] text-gray-500 mb-0.5">Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ</span>
             <div className="text-white font-mono font-bold text-lg flex items-center gap-1">
                 {formatPrice(product.price)} 
                 <span className="text-[11px] text-gray-400 font-sans font-normal">ØªÙˆÙ…Ø§Ù†</span>
             </div>
          </div>

          <a 
            href={product.link} 
            target="_blank" 
            rel="noopener noreferrer"
            className="flex items-center justify-center gap-2 w-full bg-white/5 hover:bg-primary hover:text-black text-white border border-white/10 hover:border-primary text-sm font-medium py-2.5 rounded-xl transition-all duration-300 group/btn shadow-lg shadow-black/50"
          >
            <span>Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ø®Ø±ÛŒØ¯</span>
            <ExternalLink size={16} className="group-hover/btn:-translate-y-0.5 group-hover/btn:translate-x-0.5 transition-transform" />
          </a>
        </div>
      </div>
    </div>
  );
};

export default ProductCard;
-------------------------
.\components\Typewriter.tsx:
import React, { useState, useEffect, useRef } from 'react';
import ReactMarkdown from 'react-markdown';

interface Props {
  text: string;
  onComplete?: () => void;
  speed?: number;
}

const Typewriter: React.FC<Props> = ({ text, onComplete, speed = 10 }) => {
  const [displayedText, setDisplayedText] = useState('');
  
  // Use a ref to store the latest callback. 
  // This prevents the useEffect from resetting when the parent re-renders and creates a new function reference.
  const onCompleteRef = useRef(onComplete);

  useEffect(() => {
    onCompleteRef.current = onComplete;
  }, [onComplete]);
  
  useEffect(() => {
    let index = 0;
    setDisplayedText(''); // Reset text when "text" prop actually changes

    const intervalId = setInterval(() => {
      setDisplayedText((prev) => {
        // If we reached the end, clear interval and call complete
        if (index >= text.length) {
          clearInterval(intervalId);
          if (onCompleteRef.current) onCompleteRef.current();
          return text;
        }
        return text.slice(0, index + 1);
      });
      index++;
    }, speed);

    return () => clearInterval(intervalId);
  }, [text, speed]); // Removed onComplete from dependencies

  return (
    <div className={`markdown-content ${displayedText.length < text.length ? 'typing-cursor' : ''}`}>
      <ReactMarkdown
        components={{
          strong: ({node, ...props}) => <span className="font-bold text-primary" {...props} />,
          ul: ({node, ...props}) => <ul className="list-disc list-inside my-2 space-y-1 text-gray-300" {...props} />,
          p: ({node, ...props}) => <p className="mb-2 last:mb-0" {...props} />,
          a: ({node, ...props}) => <a className="text-blue-400 hover:underline" target="_blank" {...props} />
        }}
      >
        {displayedText}
      </ReactMarkdown>
    </div>
  );
};

export default Typewriter;
-------------------------
.\services\adminService.ts:
import { supabase } from './supabaseClient';
import { generateSimpleContent } from './geminiService';

export const adminService = {
  // Admin Login
  async login(username: string, pass: string) {
    try {
      const { data, error } = await supabase
        .from('admins')
        .select('*')
        .eq('username', username)
        .eq('pass', pass)
        .maybeSingle();

      if (error) {
        if (error.code === 'PGRST205') {
            console.error("CRITICAL ERROR: Table 'admins' not found. Please run SQL.");
        }
        throw error;
      }
      return { success: !!data, admin: data };
    } catch (error) {
      console.error('Admin login error:', error);
      return { success: false, error };
    }
  },

  // Get Dashboard Statistics
  async getStats() {
    try {
      const { count: usersCount } = await supabase.from('users').select('*', { count: 'exact', head: true });
      const { data: sessions } = await supabase.from('chat_sessions').select('messages, last_modified');

      let totalMessages = 0;
      let messagesToday = 0;
      const now = new Date();
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

      sessions?.forEach((session: any) => {
        const msgs = session.messages || [];
        totalMessages += msgs.length;
        msgs.forEach((m: any) => {
            if (m.timestamp && m.timestamp >= startOfDay) messagesToday++;
        });
      });

      return {
        usersCount: usersCount || 0,
        sessionsCount: sessions?.length || 0,
        totalMessages,
        messagesToday
      };
    } catch (error) {
      console.error('Stats error:', error);
      return { usersCount: 0, sessionsCount: 0, totalMessages: 0, messagesToday: 0 };
    }
  },

  // Get Users (Robust handling)
  async getUsers() {
    // Select all columns
    const { data, error } = await supabase.from('users').select('*');
    
    if (error) {
        console.error("Error fetching users:", error);
        return [];
    }

    // Sort manually in JS to avoid column name issues in SQL sorting if schemas differ
    return (data || []).sort((a, b) => {
        const dateA = new Date(a.signup_date || a.signup_Date || 0).getTime();
        const dateB = new Date(b.signup_date || b.signup_Date || 0).getTime();
        return dateB - dateA;
    });
  },

  // Delete User
  async deleteUser(userId: string) {
    try {
        const { error } = await supabase.from('users').delete().eq('user_id', userId);
        if (error) throw error;
        return { success: true };
    } catch (error) {
        console.error("Delete user error:", error);
        return { success: false, error };
    }
  },

  // Get Sessions
  async getSessions() {
    const { data } = await supabase.from('chat_sessions').select('*').order('last_modified', { ascending: false });
    return data || [];
  },

  // AI Business Report
  async generateBusinessReport() {
    try {
        // Fetch last 50 user messages across all sessions
        const { data: sessions } = await supabase
            .from('chat_sessions')
            .select('messages')
            .order('last_modified', { ascending: false })
            .limit(20);

        let allUserTexts = "";
        sessions?.forEach((s: any) => {
            const userMsgs = (s.messages || [])
                .filter((m: any) => m.role === 'user')
                .map((m: any) => m.text)
                .join(" | ");
            allUserTexts += userMsgs + "\n";
        });

        if (!allUserTexts) return "Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.";

        const prompt = `
        ØªÙˆ ÛŒÚ© ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø§Ø±Ø´Ø¯ Ú©Ø³Ø¨ Ùˆ Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù„ÙˆØ§Ø²Ù… Ù…ÙˆØªÙˆØ± "Ø§Ø³ØªØ§Ø± Ø³ÛŒÚ©Ù„Øª" Ù‡Ø³ØªÛŒ.
        Ø¯Ø± Ø²ÛŒØ± Ù„ÛŒØ³ØªÛŒ Ø§Ø² Ù¾ÛŒØ§Ù… Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù…Ø¯Ù‡ Ø§Ø³Øª.
        Ù„Ø·ÙØ§ ÛŒÚ© Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ú©ÙˆØªØ§Ù‡ Ùˆ Ø¬Ø°Ø§Ø¨ (Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ) ØªÙˆÙ„ÛŒØ¯ Ú©Ù† Ú©Ù‡ Ø´Ø§Ù…Ù„ Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø¨Ø§Ø´Ø¯:
        1. ğŸ“ˆ **ØªØ±Ù†Ø¯Ù‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±:** Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨ÛŒØ´ØªØ± Ø¯Ù†Ø¨Ø§Ù„ Ú†Ù‡ Ù‚Ø·Ø¹Ø§ØªÛŒ Ù‡Ø³ØªÙ†Ø¯ØŸ (Ú©Ù„Ø§Ù‡ØŒ Ø§Ú¯Ø²ÙˆØ²ØŒ Ø±ÙˆØºÙ†...)
        2. ğŸ’° **Ø­Ø³Ø§Ø³ÛŒØª Ù‚ÛŒÙ…ØªÛŒ:** Ø¢ÛŒØ§ Ø¯Ù†Ø¨Ø§Ù„ Ø¬Ù†Ø³ Ø§Ø±Ø²Ø§Ù† Ù‡Ø³ØªÙ†Ø¯ ÛŒØ§ Ù„ÙˆÚ©Ø³ØŸ
        3. ğŸ’¡ **Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø±Ø§ÛŒ ØªØ§Ù…ÛŒÙ† Ú©Ø§Ù„Ø§:** Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø± Ø´Ø§Ø±Ú˜ Ú©Ù†ÛŒÙ… Ø¨Ù‡ØªØ± ÙØ±ÙˆØ´ Ù…ÛŒØ±ÙˆØ¯ØŸ
        
        Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù… Ù‡Ø§:
        ${allUserTexts}
        `;

        return await generateSimpleContent(prompt);
    } catch (error) {
        return "Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙˆØ´Ù…Ù†Ø¯.";
    }
  }
};
-------------------------
.\services\authService.ts:
import { supabase } from './supabaseClient';
import { User } from '../types';

const SESSION_KEY = 'mobinext_user_session';
const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;

interface AuthResult {
  success: boolean;
  user?: User;
  error?: string;
}

const mapUser = (data: any): User => ({
    user_id: data.user_id,
    number: data.number,
    username: data.username,
    name: data.name,
    last_name: data.last_name,
    signup_Date: data.signup_date || data.signup_Date || new Date().toISOString()
});

export const authService = {
  // Sign Up
  async signup(data: { number: string; username: string; name: string; last_name: string; pass: string }): Promise<AuthResult> {
    try {
      // Check for existing user using maybeSingle to avoid 0-row errors
      const { data: existingUser, error: checkError } = await supabase
        .from('users')
        .select('user_id')
        .or(`number.eq.${data.number},username.eq.${data.username}`)
        .maybeSingle();

      if (checkError) {
         // If it's a connection error or something serious, throw it
         throw checkError;
      }

      if (existingUser) {
        return { success: false, error: 'Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ ÛŒØ§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.' };
      }

      const { data: newUserRaw, error } = await supabase
        .from('users')
        .insert([{
            number: data.number,
            username: data.username,
            name: data.name,
            last_name: data.last_name,
            pass: data.pass
        }])
        .select()
        .single();

      if (error) throw error;
      
      const newUser = mapUser(newUserRaw);
      this.saveLocalSession(newUser);
      return { success: true, user: newUser };

    } catch (error: any) {
      console.error('Signup error:', error);
      const msg = error?.message || error?.details || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…';
      return { success: false, error: typeof msg === 'string' ? msg : JSON.stringify(msg) };
    }
  },

  // Login
  async login(identifier: string, pass: string): Promise<AuthResult> {
    try {
      // Check if identifier is number or username
      const { data: userRaw, error } = await supabase
        .from('users')
        .select('*')
        .or(`number.eq.${identifier},username.eq.${identifier}`)
        .eq('pass', pass)
        .maybeSingle();

      if (error) throw error;

      if (!userRaw) {
        return { success: false, error: 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ/Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.' };
      }
      
      const user = mapUser(userRaw);
      this.saveLocalSession(user);
      return { success: true, user };

    } catch (error: any) {
      console.error('Login error:', error);
      const msg = error?.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±';
      return { success: false, error: msg };
    }
  },

  // Local Storage Management (7 Days Rule)
  saveLocalSession(user: User) {
    const sessionData = {
      user,
      expiry: Date.now() + SEVEN_DAYS_MS
    };
    localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
  },

  checkLocalSession(): User | null {
    const sessionStr = localStorage.getItem(SESSION_KEY);
    if (!sessionStr) return null;

    try {
      const session = JSON.parse(sessionStr);
      if (Date.now() > session.expiry) {
        localStorage.removeItem(SESSION_KEY);
        return null;
      }
      return session.user;
    } catch {
      return null;
    }
  },

  logout() {
    localStorage.removeItem(SESSION_KEY);
  }
};
-------------------------
.\services\chatPersistence.ts:
import { supabase } from './supabaseClient';
import { Session, ChatMessage } from '../types';

export const chatPersistence = {
  // Load all sessions for a user
  async loadUserSessions(userId: string): Promise<Session[]> {
    try {
      const { data, error } = await supabase
        .from('chat_sessions')
        .select('*')
        .eq('user_id', userId)
        .order('last_modified', { ascending: false });

      if (error) {
        console.error('Error loading sessions:', error);
        return [];
      }

      return data.map((item: any) => ({
        id: item.id,
        title: item.title,
        messages: item.messages,
        lastModified: new Date(item.last_modified).getTime()
      }));

    } catch (e) {
      console.error(e);
      return [];
    }
  },

  // Save or Update a session
  async saveSession(userId: string, session: Session) {
    try {
      const { error } = await supabase
        .from('chat_sessions')
        .upsert({
          id: session.id,
          user_id: userId,
          title: session.title,
          messages: session.messages,
          last_modified: new Date(session.lastModified).toISOString()
        }, { onConflict: 'id' });

      if (error) console.error('Error saving session:', error);
    } catch (e) {
      console.error(e);
    }
  },

  // Delete a session
  async deleteSession(sessionId: string) {
    try {
      await supabase
        .from('chat_sessions')
        .delete()
        .eq('id', sessionId);
    } catch (e) {
      console.error(e);
    }
  }
};
-------------------------
.\services\geminiService.ts:
import { GoogleGenAI, FunctionDeclaration, Type, Content } from "@google/genai";
import { searchProducts } from "./productService";
import { FilterParams, ChatMessage } from "../types";

// PROMPTS
const BASE_PROMPT = `
Ø´Ù…Ø§ "Mobinext" ğŸ¤–ØŒ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ù…ØªØ®ØµØµ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ "Ø§Ø³ØªØ§Ø± Ø³ÛŒÚ©Ù„Øª" Ù‡Ø³ØªÛŒØ¯.
Ø´Ù…Ø§ ÛŒÚ© ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø­Ø±ÙÙ‡ Ø§ÛŒ Ù‡Ø³ØªÛŒØ¯ØŒ Ù†Ù‡ ÛŒÚ© Ù…ÙˆØªÙˆØ± Ø¬Ø³ØªØ¬Ùˆ.

ğŸš© **Ù¾Ø±ÙˆØªÚ©Ù„ ÙØ±ÙˆØ´ (Sales Funnel):**
Ù…Ú©Ø§Ù„Ù…Ù‡ Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Û³ Ù…Ø±Ø­Ù„Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯:

1. **Ù…Ø±Ø­Ù„Ù‡ Ø§Ú©ØªØ´Ø§Ù (Discovery):**
   - Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù…Ø­ØµÙˆÙ„ÛŒ Ø®ÙˆØ§Ø³Øª (Ù…Ø«Ù„Ø§Ù‹ "Ø±ÙˆØºÙ† Ù…ÙˆØªÙˆØ±" ÛŒØ§ "Ú©Ù„Ø§Ù‡ Ú©Ø§Ø³Ú©Øª")ØŒ Ø³Ø±ÛŒØ¹Ø§Ù‹ Ù„ÛŒØ³Øª Ù†Ø¯Ù‡ÛŒØ¯.
   - **Ø¨Ø§ÛŒØ¯** Ø³ÙˆØ§Ù„ Ø¨Ù¾Ø±Ø³ÛŒØ¯ ØªØ§ Ù†ÛŒØ§Ø² Ø¯Ù‚ÛŒÙ‚ Ø¨Ø± Ø§Ø³Ø§Ø³ **Ù…Ø´Ø®ØµØ§Øª ÙÙ†ÛŒ Ùˆ Ø¹Ù†ÙˆØ§Ù†** (Title/Features) Ù…Ø´Ø®Øµ Ø´ÙˆØ¯.
   - â›” **Ù…Ù…Ù†ÙˆØ¹ÛŒØª:** Ù‡Ø±Ú¯Ø² Ø¯Ø±Ø¨Ø§Ø±Ù‡ "ØªÙˆØ¶ÛŒØ­Ø§Øª" (Description) ÛŒØ§ Ù…ÙˆØ§Ø±Ø¯ Ú©Ù„ÛŒ Ùˆ Ø³Ù„ÛŒÙ‚Ù‡â€ŒØ§ÛŒ Ø³ÙˆØ§Ù„ Ù†Ù¾Ø±Ø³ÛŒØ¯.
   - **Ø³ÙˆØ§Ù„Ø§Øª Ù…Ø¬Ø§Ø² (ÙÙ‚Ø· Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ±):**
     Û±. **Ù†ÙˆØ¹/Ù…Ø¯Ù„** (Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ØµÙˆÙ„)
     Û². **Ù‚ÛŒÙ…Øª/Ø¨ÙˆØ¯Ø¬Ù‡** (ØªÙˆÙ…Ø§Ù†)
     Û³. **Ø³Ø§ÛŒØ²** (Ø¨Ø±Ø§ÛŒ Ù„Ø¨Ø§Ø³/Ú©Ù„Ø§Ù‡)
     Û´. **Ø­Ø¬Ù…/Ù„ÛŒØªØ±** (Ø¨Ø±Ø§ÛŒ Ø±ÙˆØºÙ†/ØªÙ…ÛŒØ²Ú©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§)
     Ûµ. **Ø¨Ø±Ù†Ø¯**
   - Ù‚Ø§Ù†ÙˆÙ†: Ø¯Ø± Ù‡Ø± Ù†ÙˆØ¨Øª Ø­Ø¯Ø§Ú©Ø«Ø± Û² Ø³ÙˆØ§Ù„ Ø¨Ù¾Ø±Ø³ÛŒØ¯.

2. **Ù…Ø±Ø­Ù„Ù‡ ØªØ§ÛŒÛŒØ¯ (Confirmation):**
   - ÙˆÙ‚ØªÛŒ Ø¬ÙˆØ§Ø¨ Ù‡Ø§ Ø±Ø§ Ú¯Ø±ÙØªÛŒØ¯ØŒ ÛŒÚ© Ø®Ù„Ø§ØµÙ‡ Ø¨Ú¯ÙˆÛŒÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: "Ù¾Ø³ ÛŒÚ© Ø±ÙˆØºÙ† Ù…ÙˆØªÙˆØ± Û± Ù„ÛŒØªØ±ÛŒ ØªØ§ Û²Û°Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒØ¯ØŸ")
   - Ø§Ú¯Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§ÙÛŒ Ø¨ÙˆØ¯ØŒ Ø³Ø±Ø§Øº Ù…Ø±Ø­Ù„Ù‡ Û³ Ø¨Ø±ÙˆÛŒØ¯.

3. **Ù…Ø±Ø­Ù„Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ (Action):**
   - Ø­Ø§Ù„Ø§ Ø§Ø² Ø§Ø¨Ø²Ø§Ø± \`query_knowledge_base\` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
   - Ù†ØªØ§ÛŒØ¬ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¯Ù‡ÛŒØ¯ Ùˆ ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯ Ú†Ø±Ø§ Ù…Ù†Ø§Ø³Ø¨ Ù‡Ø³ØªÙ†Ø¯.

â›” **Ù†Ø¨Ø§ÛŒØ¯Ù‡Ø§ÛŒ Ù…Ø·Ù„Ù‚:**
- Ù‡Ø±Ú¯Ø² Ù‚Ø¨Ù„ Ø§Ø² Ø¯Ø§Ù†Ø³ØªÙ† "Ø¨ÙˆØ¯Ø¬Ù‡" Ùˆ "Ù†ÙˆØ¹ Ù…Ø­ØµÙˆÙ„" Ø¬Ø³ØªØ¬Ùˆ Ù†Ú©Ù†ÛŒØ¯ (Ù…Ú¯Ø± Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ú¯ÙˆÛŒØ¯ "Ù‡Ù…Ù‡ Ù…Ø¯Ù„ Ù‡Ø§ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡").
- ÙÛŒÙ„ØªØ±ÛŒÙ†Ú¯ Ø´Ù…Ø§ Ù‡Ø±Ú¯Ø² Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª (Description) ÛŒØ§Ø´Ø¯. ÙÙ‚Ø· Ø¹Ù†ÙˆØ§Ù†ØŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ØŒ Ø³Ø§ÛŒØ²ØŒ Ø­Ø¬Ù… Ùˆ Ù‚ÛŒÙ…Øª Ù…Ù„Ø§Ú© Ø§Ø³Øª.
`;

const RAG_SYSTEM_PROMPT = `
ğŸ“¦ **Ù†Ø­ÙˆÙ‡ Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„Ø§Øª:**
- ÙˆÙ‚ØªÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯ÛŒØ¯ØŒ Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ø¨Ø§ ÙØ±Ù…Øª Ø¬Ø°Ø§Ø¨ Ù„ÛŒØ³Øª Ú©Ù†ÛŒØ¯.
- Ù‚Ø§Ù†ÙˆÙ† 70/30: Ø§Ú¯Ø± Ù…Ø­ØµÙˆÙ„ Ø¯Ù‚ÛŒÙ‚ Ù†Ø¨ÙˆØ¯ØŒ Ù…Ø­ØµÙˆÙ„ Ù…Ø´Ø§Ø¨Ù‡ Ø¨Ø§ Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¯Ù‡ÛŒØ¯.
- Ù‚ÛŒÙ…Øª Ù‡Ø§ Ø±Ø§ Ø­ØªÙ…Ø§ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† Ø°Ú©Ø± Ú©Ù†ÛŒØ¯.
`;

// Tool Definition
const queryKnowledgeBaseTool: FunctionDeclaration = {
  name: "query_knowledge_base",
  description: "Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù†ØŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ØŒ Ø³Ø§ÛŒØ²ØŒ Ø­Ø¬Ù… Ùˆ Ù‚ÛŒÙ…Øª. (ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø­ØµÙˆÙ„ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)",
  parameters: {
    type: Type.OBJECT,
    properties: {
      category: {
        type: Type.STRING,
        description: "Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ Ø§ØµÙ„ÛŒ ÛŒØ§ Ù†ÙˆØ¹ Ù…Ø­ØµÙˆÙ„ (Ú©Ù„Ø§Ù‡ Ú©Ø§Ø³Ú©ØªØŒ Ø±ÙˆØºÙ† Ù…ÙˆØªÙˆØ±ØŒ Ø§Ú¯Ø²ÙˆØ²)"
      },
      min_price: {
        type: Type.NUMBER,
        description: "Ú©Ù Ù‚ÛŒÙ…Øª (Ø§Ú¯Ø± Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª 0)"
      },
      max_price: {
        type: Type.NUMBER,
        description: "Ø³Ù‚Ù Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ø§Ø±Ø¨Ø± (ØªÙˆÙ…Ø§Ù†)"
      },
      keywords: {
        type: Type.STRING,
        description: "Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ ÙÙ†ÛŒ: Ø³Ø§ÛŒØ² (L, XL)ØŒ Ø­Ø¬Ù… (1L, 4L)ØŒ Ø¨Ø±Ù†Ø¯ØŒ ÛŒØ§ Ù…Ø¯Ù„ Ø®Ø§Øµ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†."
      },
      brand: {
        type: Type.STRING,
        description: "Ø¨Ø±Ù†Ø¯ Ø®Ø§Øµ"
      }
    },
    required: ["category"]
  }
};

let genAI: GoogleGenAI | null = null;

const getClient = () => {
    if (!genAI) {
        genAI = new GoogleGenAI({ apiKey: process.env.API_KEY });
    }
    return genAI;
};

// Map UI ChatMessages to Gemini Content format
const mapHistoryToContent = (messages: ChatMessage[]): Content[] => {
    return messages
        .filter(m => m.role !== 'system')
        .map(m => {
            // Remove internal UI fields if expanding logic later
            return {
                role: m.role,
                parts: [{ text: m.text }]
            };
        });
};

export const initializeChat = () => {
    getClient();
};

// New function for Admin Analysis
export const generateSimpleContent = async (prompt: string): Promise<string> => {
    const client = getClient();
    try {
        const response = await client.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
            config: {
                temperature: 0.5,
            }
        });
        return response.text || "Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§";
    } catch (error) {
        console.error("AI Gen Error:", error);
        return "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ";
    }
};

export const sendMessageToGemini = async (newMessage: string, history: ChatMessage[]) => {
  const client = getClient();
  
  // Create a completely new chat session for every request to ensure statelessness on the server side
  // but preserving context via the 'history' array passed from the client.
  // This solves the "Session Isolation" issue.
  const chatSession = client.chats.create({
    model: "gemini-2.5-flash",
    history: mapHistoryToContent(history), 
    config: {
      systemInstruction: BASE_PROMPT + "\n" + RAG_SYSTEM_PROMPT,
      temperature: 0.3, // Lower temperature for more disciplined logic following
      tools: [{ functionDeclarations: [queryKnowledgeBaseTool] }],
    },
  });

  try {
    let result = await chatSession.sendMessage({ message: newMessage });
    
    // Check for function calls
    const calls = result.functionCalls;
    
    if (calls && calls.length > 0) {
      const call = calls[0];
      
      if (call.name === "query_knowledge_base") {
        console.log("ğŸ› ï¸ Mobinext Searching DB:", call.args);
        
        // Execute Search
        const products = await searchProducts(call.args as FilterParams);
        
        // Create context
        const productContext = products.length > 0 
            ? JSON.stringify(products.slice(0, 10))
            : "Ù‡ÛŒÚ† Ù…Ø­ØµÙˆÙ„ Ø¯Ù‚ÛŒÙ‚ÛŒ Ø¨Ø§ Ø§ÛŒÙ† ÙÛŒÙ„ØªØ±Ù‡Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ù‚Ø§Ù†ÙˆÙ† 70/30 Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù† Ùˆ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù†Ø²Ø¯ÛŒÚ© Ø±Ø§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡.";
        
        // Send tool response
        result = await chatSession.sendMessage({
          message: [{
            functionResponse: {
              name: call.name,
              id: call.id,
              response: { result: productContext }
            }
          }]
        });
        
        return {
          text: result.text,
          products: products
        };
      }
    }

    return {
      text: result.text,
      products: []
    };

  } catch (error) {
    console.error("Gemini Error:", error);
    return {
      text: "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø´Ø¨Ú©Ù‡ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.",
      products: []
    };
  }
};
-------------------------
.\services\productService.ts:
import { Product, ProductMatch, FilterParams, DATA_URL } from '../types';

let productDatabase: Product[] = [];

// Fetch and cache the database
export const loadProductDatabase = async (): Promise<void> => {
  if (productDatabase.length > 0) return;
  
  try {
    const response = await fetch(DATA_URL);
    if (!response.ok) throw new Error("Failed to load product data");
    const data = await response.json();
    
    // Normalize data structure if needed depending on raw JSON format
    // Assuming the JSON is an array of objects. We map to our interface.
    productDatabase = Array.isArray(data) ? data.map((item: any, index: number) => ({
      id: item.id || index,
      title: item.title || item.name || "Ù…Ø­ØµÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…",
      price: parsePrice(item.price),
      link: item.link || item.url || "#",
      image: item.image || item.img || null,
      category: item.category || "Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ",
      features: normalizeFeatures(item.features),
      description: item.description || ""
    })) : [];
    
    console.log(`Loaded ${productDatabase.length} products.`);
  } catch (error) {
    console.error("Error loading knowledge base:", error);
    productDatabase = []; // Fallback
  }
};

// Helper to normalize features which might be strings or objects {label, value}
const normalizeFeatures = (features: any): string[] => {
    if (!Array.isArray(features)) return [];
    return features.map(f => {
        if (typeof f === 'string') return f;
        if (f && typeof f === 'object') {
            if (f.label && f.value) return `${f.label}: ${f.value}`;
            if (f.value) return String(f.value);
            return Object.values(f).join(': ');
        }
        return String(f);
    });
};

// Helper to clean price strings to numbers
const parsePrice = (priceRaw: string | number): number => {
  if (typeof priceRaw === 'number') return priceRaw;
  if (!priceRaw) return 0;
  // Remove non-digits
  const numericString = priceRaw.replace(/\D/g, '');
  return parseInt(numericString, 10) || 0;
};

// Search Logic implementing the prompt's requirements
export const searchProducts = async (params: FilterParams): Promise<ProductMatch[]> => {
  await loadProductDatabase();

  const { category, min_price = 0, max_price = 1000000000, keywords, brand } = params;
  
  // 1. Exact Filtering
  let candidates = productDatabase.filter(p => {
    // Category Filter (Fuzzy match)
    if (category && !p.category?.includes(category) && !p.title.includes(category)) {
      // Check for broad category matches if specific fails
      return false;
    }
    
    // Price Filter
    const price = typeof p.price === 'number' ? p.price : parsePrice(p.price);
    if (price < min_price || price > max_price) return false;

    // Brand Filter
    if (brand && !p.title.includes(brand)) return false;

    return true;
  });

  // Keyword scoring
  // STRICT UPDATE: Excluded 'description' from search scope. 
  // Only searching Title and Features (which contains size, volume, etc.)
  if (keywords) {
    const keywordList = keywords.split(' ').filter(k => k.length > 2);
    candidates = candidates.map((p: any) => {
      let score = 0;
      // ONLY Title and Features are considered. Description is IGNORED.
      const textSpace = `${p.title} ${p.features?.join(' ')}`.toLowerCase();
      
      keywordList.forEach(k => {
        if (textSpace.includes(k.toLowerCase())) score += 1;
      });
      return { ...p, _score: score };
    }).filter((p: any) => p._score > 0).sort((a: any, b: any) => b._score - a._score);
  }

  // 2. Logic for "Close Match" (The 70/30 rule from prompt)
  // If we have very few results (< 3), we relax the price constraint
  let finalResults: ProductMatch[] = candidates.map(c => ({ ...c }));

  if (finalResults.length < 5) {
     const priceTolerance = 2000000; // 2 Million Toman tolerance
     const relaxedMax = max_price + priceTolerance;
     const relaxedMin = Math.max(0, min_price - priceTolerance);

     const closeMatches = productDatabase.filter(p => {
        // Exclude already found
        if (finalResults.find(fr => fr.title === p.title)) return false;
        
        // Check Category
        if (category && !p.category?.includes(category) && !p.title.includes(category)) return false;

        const price = typeof p.price === 'number' ? p.price : parsePrice(p.price);
        
        // Relaxed Price Check
        if (price >= relaxedMin && price <= relaxedMax) {
           return true;
        }
        return false;
     }).map(p => ({
        ...p,
        isCloseMatch: true,
        matchReason: "Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ø¨ÙˆØ¯Ø¬Ù‡ Ø´Ù…Ø§"
     }));

     // Sort close matches by price difference
     closeMatches.sort((a, b) => {
        const priceA = typeof a.price === 'number' ? a.price : parsePrice(a.price);
        const priceB = typeof b.price === 'number' ? b.price : parsePrice(b.price);
        // Find distance from target range
        const distA = priceA > max_price ? priceA - max_price : min_price - priceA;
        const distB = priceB > max_price ? priceB - max_price : min_price - priceB;
        return distA - distB;
     });

     finalResults = [...finalResults, ...closeMatches];
  }

  // Cap at 10 items
  return finalResults.slice(0, 10);
};
-------------------------
.\services\supabaseClient.ts:
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = "https://jhjlxljhijhrvclgsbzc.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impoamx4bGpoaWpocnZjbGdzYnpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjQ4NzYsImV4cCI6MjA4MDg0MDg3Nn0.8WwtsrOE3Fch_vFczeu6Fz9A2QiO_Pbwh_MxuhFUFwY";

export const supabase = createClient(supabaseUrl, supabaseKey);
-------------------------
